
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault6/1encrypt_key/">
      
      
        <link rel="prev" href="../../vault5/6vault_k8s/">
      
      
        <link rel="next" href="../2bak_storage/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>L1 Managing the Encryption Key - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l1-managing-the-encryption-key" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L1 Managing the Encryption Key
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/3vault_rotate/" class="md-nav__link">
        L3 透过 Vault 定期 rotate credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/4encryption_key/" class="md-nav__link">
        L4 Managing Encryption and Seal Keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/8vaba_monitor/" class="md-nav__link">
        L8 Configuring Auditing and Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/3vault_tf_nd/" class="md-nav__link">
        L3 Integrating Vault with Terraform & Nomad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          L1 Managing the Encryption Key
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        L1 Managing the Encryption Key
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    1 Introduction
  </a>
  
    <nav class="md-nav" aria-label="1 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#four-modules" class="md-nav__link">
    Four modules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-installing-vault" class="md-nav__link">
    2 Installing Vault
  </a>
  
    <nav class="md-nav" aria-label="2 Installing Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-consul" class="md-nav__link">
    Install Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-vault" class="md-nav__link">
    Install Vault
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-unsealing-the-vault" class="md-nav__link">
    2 Unsealing the Vault
  </a>
  
    <nav class="md-nav" aria-label="2 Unsealing the Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-unsealing-method-with-gpg" class="md-nav__link">
    Manual unsealing method with GPG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rekeying-rotation" class="md-nav__link">
    Rekeying Rotation
  </a>
  
    <nav class="md-nav" aria-label="Rekeying Rotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vault-stays-unsealed-until" class="md-nav__link">
    Vault stays unsealed until:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-if" class="md-nav__link">
    What if?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#possible-solutions" class="md-nav__link">
    Possible Solutions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explore-the-rekey-and-rotation-method" class="md-nav__link">
    Explore the rekey and rotation method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rekeying" class="md-nav__link">
    Rekeying
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-a-new-root-token" class="md-nav__link">
    Generate a new root token..
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-new-token" class="md-nav__link">
    set the new token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-the-key-rotation" class="md-nav__link">
    Start the key rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automate-the-rotation" class="md-nav__link">
    Automate the rotation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-auto-unsealing" class="md-nav__link">
    3 Auto Unsealing
  </a>
  
    <nav class="md-nav" aria-label="3 Auto Unsealing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migrate-the-seal" class="md-nav__link">
    Migrate the seal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#associating-policies" class="md-nav__link">
    Associating Policies
  </a>
  
    <nav class="md-nav" aria-label="Associating Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-token" class="md-nav__link">
    Root Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-or-update-a-policy" class="md-nav__link">
    create or update  a policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-the-policy" class="md-nav__link">
    Read the policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-a-token-for-the-policy" class="md-nav__link">
    Generate a token for the policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticate-with-that-token" class="md-nav__link">
    Authenticate with that token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-token_1" class="md-nav__link">
    Root Token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    1 Introduction
  </a>
  
    <nav class="md-nav" aria-label="1 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#four-modules" class="md-nav__link">
    Four modules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-installing-vault" class="md-nav__link">
    2 Installing Vault
  </a>
  
    <nav class="md-nav" aria-label="2 Installing Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-consul" class="md-nav__link">
    Install Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-vault" class="md-nav__link">
    Install Vault
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-unsealing-the-vault" class="md-nav__link">
    2 Unsealing the Vault
  </a>
  
    <nav class="md-nav" aria-label="2 Unsealing the Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manual-unsealing-method-with-gpg" class="md-nav__link">
    Manual unsealing method with GPG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rekeying-rotation" class="md-nav__link">
    Rekeying Rotation
  </a>
  
    <nav class="md-nav" aria-label="Rekeying Rotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vault-stays-unsealed-until" class="md-nav__link">
    Vault stays unsealed until:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-if" class="md-nav__link">
    What if?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#possible-solutions" class="md-nav__link">
    Possible Solutions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explore-the-rekey-and-rotation-method" class="md-nav__link">
    Explore the rekey and rotation method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rekeying" class="md-nav__link">
    Rekeying
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-a-new-root-token" class="md-nav__link">
    Generate a new root token..
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-new-token" class="md-nav__link">
    set the new token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-the-key-rotation" class="md-nav__link">
    Start the key rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automate-the-rotation" class="md-nav__link">
    Automate the rotation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-auto-unsealing" class="md-nav__link">
    3 Auto Unsealing
  </a>
  
    <nav class="md-nav" aria-label="3 Auto Unsealing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migrate-the-seal" class="md-nav__link">
    Migrate the seal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#associating-policies" class="md-nav__link">
    Associating Policies
  </a>
  
    <nav class="md-nav" aria-label="Associating Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-token" class="md-nav__link">
    Root Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-or-update-a-policy" class="md-nav__link">
    create or update  a policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-the-policy" class="md-nav__link">
    Read the policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-a-token-for-the-policy" class="md-nav__link">
    Generate a token for the policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticate-with-that-token" class="md-nav__link">
    Authenticate with that token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-token_1" class="md-nav__link">
    Root Token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l1-managing-the-encryption-key"><strong>L1 Managing the Encryption Key</strong></h1>
<h2 id="1-introduction"><strong>1 Introduction</strong></h2>
<h3 id="four-modules">Four modules</h3>
<p><strong>Managing the encryption key</strong></p>
<ul>
<li>Highlight Security concerns</li>
</ul>
<p><strong>Managing the Storage backend</strong></p>
<ul>
<li>Discuss the operational complexities</li>
</ul>
<p><strong>Managing Vault during an incident</strong></p>
<ul>
<li>Troubleshoot the Vault server</li>
</ul>
<p><strong>Managing plugins and server upgrades</strong></p>
<ul>
<li>Demonstrate server upgrade</li>
</ul>
<h2 id="2-installing-vault"><strong>2 Installing Vault</strong></h2>
<pre><code># Now that we have a K8s cluster to work with, let's get Vault deployed with Helm
export SECRET_NAME=vault-tls
export NAMESPACE=vault
export certificate_cn=&quot;&quot;

# First we will add the Helm repo for Vault
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update hashicorp

# Add a namespace for the Vault cluster
kubectl create namespace ${NAMESPACE}

# Create a secret with the Vault certificate info
kubectl create secret generic vault-tls \
  --namespace ${NAMESPACE} \
  --from-file=vault.key=./certs/vault.key \
  --from-file=vault.crt=./certs/vault.crt
</code></pre>
<ul>
<li><strong><code>vault.key</code></strong></li>
</ul>
<pre><code>-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAp+l+jV5wiDRbwOaTWWGBPW/fLga2ifMlkD2JMyCeoe/odPQo
7n17gI3GD62UfZJZGJBAYQHLMiGbbS863ftQd+EZ5L54tkZC8aHxyokAN/zwGX/q
M8dULsy/6sDfP2qF3TlccIKTjkEemRsGt2hQGbgyIQpljchwJhHSOrBRJf9UDu+R
COvuK8RBd9eIrvVKu1OmQXrhOQQnjfCE+u/aM9kWCjUR2I/ZdLxsVIwjcDY8al7q
/NLZ+j+ZEseHHrL487umwTWO0wl/ixcJQqbJSxCblMaiTlt9nWl5cuHzknDCk/Fz
SlOOdBvmWRr42+JC9EX27furk6R4lGjmcWRu9QIDAQABAoIBAET3bJlYHtRy3PTg
P8lIeTLozjwzWapTiiwyejXbwgw1Y78VwfIi7CUjFiS+YO0qvRmPtkGh4PnYP+Sa
r40ZejWi6WXArgf/1+MzZwKPPt3AMEXo+iMGThdi1bjwO0Hq2MzCkKtNlpmpOY4d
Qab3W18U/tH/WTLhDt80FqswXEREbsth3B6v4MEsnBzDrzO+f0J4VobjPvVKfb38
NdUxfa9c+C6MFQ/pbA+OR5fOgiTUBpXQkIP9B7IUbBcZSQWH1AdlzhzvLCUQC9uU
p1ULBcibvsyKuJfzaIPeN5OitECKjJP1/OPkwIiyhQmlZniLvkoMbEqoJxA86Yeo
R5M39UECgYEAz6mlgfPDIOXzeEoj74/Jz0Lb/s0b2rH1ImyzwAh6CR/mZr5dCja9
nci+eoO9EMyf4VPt+gmsy0Rg5VdF3g8WP5GwXONlTPdgPu1j5oNFKy9agcG+Je/r
RYCpHXUhNCtJZ32JcOK7+/pWTqjx5XwGe1wEp1DVgAgMrJX2xnj68KkCgYEAzv8p
KGTgEmcvGPA6flO1PWpvFdbX+tMgt/BuPnULQRU3Vbt0eqGqGYBWDoRh84viyWPw
kTG2UE1oLqsAn2QEo3p8wHkCq8NjjTws9G9blIZ6qq75ctomL6LNc20Y/GP9GaHh
QinMELizkDr9FGIQGQZDpbXfL/kwzUNNeq9bn20CgYEAuuLOFJmv7heEeakfliUt
Vd2x5ynn+3VUS1rQme4HBdcznxuK1/pTw4A6DEArEsdUy5ChBvlWDMjI+x0Dv8iM
GUGgGrh7Hj0y3O7/jSBuS2MebNBTtAirD62uhNg4vZ6HPR/5ZSJoU2kD616X9BMe
Mj6p4XoZ6lNUNK3xnMSb8aECgYATfa1Hc3Ax62tg4sXvPTyUouAA43EE2jp7d3U6
BlVf9Hp4ZSVLostciVwRE+ARSbu6EOIHGfI7z34e3tU5LPbO2erDSOG6gLRwCRmG
jrHF43/LcJxmdyofVCoaU0yF/3hGoJqQW1UuweWOkC9iavVvFcrq4Jw6bTFuMocq
JTbwZQKBgQCSr85uE9+oBeXW0tWhoNhuuxWqlR+AEFTp+OAoaG2nthmjx1Nl/kPG
0T1/UevLL1Np6EO7dLLgo2kSNCxKgfG9IKv3sA6MDfhxYWyYfweiklxTtpCrCO+/
ieCO0qespJ5x190+9kqVf8SMqxxcScgfjQjaUrPSnH6svUmqDik5OQ==
-----END RSA PRIVATE KEY-----
</code></pre>
<ul>
<li><code>vault.crt</code></li>
</ul>
<pre><code>-----BEGIN CERTIFICATE-----
MIIC9jCCAd4CCQCXVSNk7loeKTANBgkqhkiG9w0BAQUFADA9MRUwEwYDVQQKDAxz
eXN0ZW06bm9kZXMxJDAiBgNVBAMMG3N5c3RlbTpub2RlOnZhdWx0LnZhdWx0LnN2
YzAeFw0yMjA3MDEwODUyMjRaFw0yMzA3MDEwODUyMjRaMD0xFTATBgNVBAoMDHN5
c3RlbTpub2RlczEkMCIGA1UEAwwbc3lzdGVtOm5vZGU6dmF1bHQudmF1bHQuc3Zj
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAp+l+jV5wiDRbwOaTWWGB
PW/fLga2ifMlkD2JMyCeoe/odPQo7n17gI3GD62UfZJZGJBAYQHLMiGbbS863ftQ
d+EZ5L54tkZC8aHxyokAN/zwGX/qM8dULsy/6sDfP2qF3TlccIKTjkEemRsGt2hQ
GbgyIQpljchwJhHSOrBRJf9UDu+RCOvuK8RBd9eIrvVKu1OmQXrhOQQnjfCE+u/a
M9kWCjUR2I/ZdLxsVIwjcDY8al7q/NLZ+j+ZEseHHrL487umwTWO0wl/ixcJQqbJ
SxCblMaiTlt9nWl5cuHzknDCk/FzSlOOdBvmWRr42+JC9EX27furk6R4lGjmcWRu
9QIDAQABMA0GCSqGSIb3DQEBBQUAA4IBAQBmogQGNT+p429ltJD/fsBRd58r0hSS
xZPLObKehl6jZYb4Dp3Up4Nh0ZkykzJeA/9bHqqaTzf77+/2uxmYwNCdxsLz4Fff
zbEfeyVDGImHiKZiIG814sjWUkt5FD4m5w4oMDtH9Y4j48oXdMDVCCSGgx2qH2p1
tmBiSa5MHmK1QI8d+k4xkqNxowExeVdMcMRAa2ey0mdp3fuCDSPltb7rLPtl0IaH
MtZZSyfV5rjbfnjBs4uXrIJIjsraqWJz+MdoaanZs/CiMUgzZhb8iOaFPZYyXMIz
709mgDIqmtWPlPVXetixuMG5KXP5yoaM0YnjvHfwz0mGkH130EuIBjuJ
-----END CERTIFICATE-----
</code></pre>
<h3 id="install-consul">Install Consul</h3>
<pre><code># Deploy Consul to provide storage for Vault
helm install consul hashicorp/consul --namespace vault
</code></pre>
<h3 id="install-vault">Install Vault</h3>
<pre><code># Deploy Vault cluster to K8s using helm
helm install vault hashicorp/vault \
  --namespace vault \
  --values values.yaml
</code></pre>
<ul>
<li><strong><code>values.yaml</code></strong></li>
</ul>
<pre><code># Vault Helm Chart Value Overrides
global:  
  enabled: true  
  tlsDisable: false

server:

  readinessProbe:
    enabled: true
    path: &quot;/v1/sys/health?standbyok=true&amp;sealedcode=204&amp;uninitcode=204&quot;
  livenessProbe:
    enabled: true
    path: &quot;/v1/sys/health?standbyok=true&quot;
    initialDelaySeconds: 60

  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/vault-tls/vault.ca
    VAULT_SKIP_VERIFY: true

  extraVolumes:
    - type: secret
      name: vault-tls

  standalone:
    enabled: &quot;true&quot;

    # config is a raw string of default configuration when using a Stateful
    # deployment. Default is to use a PersistentVolumeClaim mounted at /vault/data
    # and store data there. This is only used when using a Replica count of 1, and
    # using a stateful set. This should be HCL.

    # Note: Configuration files are stored in ConfigMaps so sensitive data
    # such as passwords should be either mounted through extraSecretEnvironmentVars
            # tls_client_ca_file = &quot;/vault/userconfig/vault-tls/vault.ca&quot;
    # or through a Kube secret.  For more information see:
    # https://www.vaultproject.io/docs/platform/k8s/helm/run#protecting-sensitive-vault-configurations
    config: |

      listener &quot;tcp&quot; {
        address = &quot;[::]:8200&quot;
        cluster_address = &quot;[::]:8201&quot;
        tls_cert_file = &quot;/vault/userconfig/vault-tls/vault.crt&quot;
        tls_key_file  = &quot;/vault/userconfig/vault-tls/vault.key&quot;

      }


      storage &quot;consul&quot; {
        path = &quot;vault&quot;
        address = &quot;consul-consul-server:8500&quot;
      }
      ui = true
      log_level = &quot;Debug&quot;


  service:
    type: LoadBalancer
    annotations: |
      &quot;service.beta.kubernetes.io/aws-load-balancer-name&quot;: &quot;vault-server&quot;
</code></pre>
<pre><code># We can monitor the install by doing a watch on the namespace
kubectl get pods -n vault -w

NAME    READY   STATUS  RESTART SAGE
consul-consul-client-7zx62  1/1 Running 0 17m
consul-consul-client-crr7j  1/1 Running 0 17m
consul-consul-client-djppb  1/1 Running 0 17m
consul-consul-server        1/1 Running 0 17m
consul-consul-server-1  1/1 Running 0 17m
consul-consul-server-2  1/1 Running 0 17m
vault-agent-injector-6bf6cdb945-6g65z 1/1 Running 0 15m
Vault-1/1       Running 1/1 1（10sago）90S
</code></pre>
<pre><code># Once they are all Running, we're in good shape
# Now get the LoadBalancer IP address for the server
kubectl get service vault -n vault

NAME TYPE CLUSTER-IP EXTERNAL-IP PORT (S) AGE
vault loadBalancer 19. 199.49. 175 466846f95751a-1973715929.us-east-1.elb.amazonaws.com
8200:32339/TCP,820130339/TCP 16m
</code></pre>
<pre><code># The address for the Vault server will be the dns label 
# plus the Azure region cloudapp.azure.com 
# Ex. vaultf-9f8a7a6.eastus.cloudapp.azure.com
# You'll need to add a CNAME entry for this to your public DNS
# Ex. vault-aks.globomantics.xyz

export VAULT_ADDR=&quot;https://${certificate_cn}:8200&quot;
</code></pre>
<pre><code>vault status -tls-skip-verify
key         vaule
---         ----
seal Type    shamir
···
</code></pre>
<h2 id="2-unsealing-the-vault">2 Unsealing the Vault</h2>
<p>Vault server is sealed. You need to unseal it. You can unseal the Vault server in three different ways.</p>
<ul>
<li><strong>Manual unsealing</strong></li>
</ul>
<p>2 or more operators enter encryption key manually</p>
<ul>
<li><strong>Auto unsealing</strong></li>
</ul>
<p>A cloud key management service (KMS) is used</p>
<ul>
<li><strong>Transit unsealing</strong></li>
</ul>
<p>One vault server is used to unseal another</p>
<pre><code>## Unsealing command 
vault operator init -tls-skip-verify -key-shares=3 -key-threshold=2

Unseal Key 1: munsuu2SP6nXp1Fgk4PcIi+SA2DrAT8ACelvxtBn9BW7
Unseal Key 2: WAqRCuM4nsG®J+6pDPxovAhW568Q06EVnoxaNISMo9of
Unseal Key 3: ZxgC1G7T1hXDQkI1copnPRFdPgfShSBSWc/PV+AnvnJ5

Initial Root Token: hvs.0Qy1NYRSVD8VQsU8IUDLstQJ

Vault initialized with 3 key shares and a key threshold of 2. Please securely
distribute the key shares printed above. When the Vault is re-sealed.
restarted, or stopped, you must supply at least 2 of these keys to unseal it
before it can start servicing requests.
Vault does not store the generated root key. Without at least 2 keys to
reconstruct the root key, Vault will remain permanently sealed!
It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. 

See &quot;vault operator rekey&quot; for more information.
</code></pre>
<h3 id="manual-unsealing-method-with-gpg">Manual unsealing method with GPG</h3>
<p>You can use the PGP, GnuPG, or keybase keys. </p>
<p>There is an option in the vault init command in which you can pass the GPG keys of the operators who are handling the unsealing keys. </p>
<p><strong>The Vault will then return the unsealing keys encrypted with those GPG keys.</strong></p>
<p>You can then share those unsealing keys over chat or email to the respective operator. </p>
<p><img alt="Alt Image Text" src="../../images/chap6_1_1.png" title="Body image" /></p>
<pre><code>### import pgp keys
gpg --import dev-x.asc
gpg --import dev-y.asc
gpg --import dev-z.asc
</code></pre>
<ul>
<li><strong><code>dev-x-encoded.asc</code></strong></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr7vURYJKwYBBAHaRw8BAQdAbs7pgAejCRBNnJu/ljyFBvKvka7ipnRof+ti
fgA6h+e0G2Rldi14IDxkZXYteEB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEx+DS
/UcaKsnx22UgvoGy1kjA3ywFAmK+71ECGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQvoGy1kjA3ywnYgEAk+OYqhhGiSv6311WzCRV/IPZldgO
f0bk+wb7YHw6Z2MA/idvU4EAV5qvG3nvzX1BkMZU+RIfkluMR03aG6JoexYFuDgE
Yr7vURIKKwYBBAGXVQEFAQEHQBwBNRy1OdcfIrjcVFswZqqZm5go1BLammm+yazS
+SNEAwEIB4h+BBgWCgAmFiEEx+DS/UcaKsnx22UgvoGy1kjA3ywFAmK+71ECGwwF
CQPCZwAACgkQvoGy1kjA3yztzwD/azc7Mrg4DkvFk2dsGeCm9fFCjNOAK5KYDpC5
zXuFp3wBAM61CBVuMVmu+xGrfEvka4cLFy83W8CwzRd2Pa01/5sH
=LqfI
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<ul>
<li><strong><code>dev-y-encoded.asc</code></strong></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr70xBYJKwYBBAHaRw8BAQdARciLwv4WRskXRrNpm5yBDQlOZnribYn9egut
D0jO+OG0G2Rldi15IDxkZXYteUB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEkIMR
wMAjc0Rklkz+HwT+dJXNVcwFAmK+9MQCGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQHwT+dJXNVcyzaQEA5jei8Svjqzs4wU/+VpVisgTwgse6
v1+wuxLkKJFfSFcA/29esVLpbc+S8uXlMj2dEbd3yKg7prbqale3DK24bEoMuDgE
Yr70xBIKKwYBBAGXVQEFAQEHQBYwyIY0D7Pe2F18yn7CNYnBd9uqtN3yReXTtI1t
ESsyAwEIB4h+BBgWCgAmFiEEkIMRwMAjc0Rklkz+HwT+dJXNVcwFAmK+9MQCGwwF
CQPCZwAACgkQHwT+dJXNVcxHCwEAx8M/eUWAr3kmz3YSsAl1pR26o7tBLiuahtVd
nq38ntkBALmrtPzD9hSiEVR+hJaSAgN01KXmwEsvvrQSHXhHpGQM
=WIul
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<ul>
<li><code>dev-z-encoded.asc</code></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr703RYJKwYBBAHaRw8BAQdA9QV2avIfeVHy72z6h2rIVlRePBiuyjdaLh4H
nRTL8xu0G2Rldi16IDxkZXYtekB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEjVBp
XY3YIsd3YD2KMQtnpoP/bhwFAmK+9N0CGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQMQtnpoP/bhzP9AEAmiIoe09CMqyD4HztKhjbrnMG5C/w
xn3QM6gycJsRI94BANIttzCnAJTymNwkm+PJtHemI5sVq17DZytfCuBTh6kLuDgE
Yr703RIKKwYBBAGXVQEFAQEHQNETh+oi8848nudzbicVPBfA0FcUqtfU5S3oFDer
2m12AwEIB4h+BBgWCgAmFiEEjVBpXY3YIsd3YD2KMQtnpoP/bhwFAmK+9N0CGwwF
CQPCZwAACgkQMQtnpoP/bhzBhwEAk2KC8A/+wesH5NImZvlngee2gDM+WtvFnGyJ
s7MaHDIA/AsFDQenANjqtUuek/y5nzBlMcZAQ5u3Nb12Fb4glNIC
=1hNn
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<pre><code>$ gpg --list-keys
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_2.png" title="Body image" /></p>
<pre><code>### export public keys to disk with base64 encoding

gpg --export -a dev-x &gt; dev-x-encoded.asc
gpg --export -a dev-y &gt; dev-y-encoded.asc
gpg --export -a dev-z &gt; dev-z-encoded.asc
</code></pre>
<pre><code>vault operator init -tls-skip-verify -key-shares=3 -key-threshold=2 -pgp-keys=&quot;dev-x-encoded.asc,dev-y-encoded.asc,dev-z-encoded.asc

* Unseal Key 1: wUADBdRFLivxYIWSAQdA7INCsya24F/EDByraPMoE@FVumEZ6y68FuFFkHBN@jEgdRyrWyeDM5yr+/ekdRxaS8mCFcieTNJdfX2CqrYxM2LS4AHkp9PKe02KARpgS+KQnelcH+GAfuC64N7hsezgTOJAAwsY40rmj9MOuY9zD3h7srA3GsPyXBDMjIKfdkPK@wp45y00J6IQzF50WIQ4P3VHhPuU6XUeSEpLOvuJ3z9d770FfQ6GeDB4U464FLkbXaP@+i1/3kkfKmhQ6aeReJltugC4ZF5AA==
* Unseal Key 2: wU4Dn2PrEmM8HCASAQdAcEWojkCHyI27mxW9Hq+FK9rf0e6V45m5TcG+Wkqp9ykqyh9Lv43ZJpxNDLZCOExmSduxR8yIsI2mfToEs80gDrvS4AHkYy5+TuS3rKLLPbmYgJQ5r+Fq1eD24Drh4ILgGuI59TdH4Bfm4heNqYY/aB/30pkmnHPegkJjuOZPf52Ptg2nFSDAwhPccbnx+LUg1JYif015SJVRYTfTgX5iN86K6FGkWwFnuBK4RRU4GTksiNTZ7ymn611pSU117pij+J05cfj4Wf+AA==
* Unseal Key 3: wU4DkFP01xIC1Z0SAQdA+7x18qF9JrGw331Rx615kpiW1Mi4Wb+WX/DhuweT91MqiubgefE4YkRa1G7fIrts1ofSVII607fPYR/VRnrvWKzS4AHktf@JAQ8hMqQpo/BOSPkWZOHI50AZ4Nzh5nPgx0L97giN4AnmfvEAISIXtd8ZDi3eJNiOF+Xf8VMmG5vtzrRkv17hog7yNKtwkfJ49DRjT5BikKP6NG5b3PHGjTOzSAmY6JLZZ+Bp4aFi4D3k2nXWgrwnPqYE6QZ5tg/OhuI1xC864Z24AA==

Initial Root Token: hvs.NIWJmUZJm4kno8tcoHmeT67X

Vault initialized with 3 key shares and a key threshold of 2. Please securely
distribute the key shares printed above. When the Vault is re-sealed,restarted, or stopped, you must supply at least 2 of these keys to unseal it before it can start servicing requests, Vault does not store the generated root key. Without at least 2 keys to

Vault does not store the generated root key. Without at least 2 keys to
</code></pre>
<ul>
<li>Root Token: hvs.NIWJmUZJm4kno8tcoHmeT67X</li>
</ul>
<pre><code>$ echo wUADBd... | base64 --decode | gpg -dq

a8373b92f595ece47a9159aada8d4d880b2b4da7c7a64378031ed23a8f418037d2

echo wU4Dn2PrEmM8... | base64 --decode | gpg -dq

382492d0353209ee28bd05dc96f42aee2b62e2c62c1f18579c67ec3053317647fd
</code></pre>
<pre><code>$ vault operator unseal -tls-skip-verify
....
Unseal Progress 1/2

$ vault operator unseal -tls-skip-verify
</code></pre>
<h2 id="rekeying-rotation">Rekeying Rotation</h2>
<p>This vault server will remain unsealed until the vault server is restarted, there is an error at the storage layer of the vault server, or the vault server is sealed manually or via the API in case of a cyberattack. </p>
<h3 id="vault-stays-unsealed-until">Vault stays unsealed until:</h3>
<ul>
<li>Server is restarted</li>
<li>An error at storage layer</li>
<li>Sealed manually via API</li>
</ul>
<h3 id="what-if">What if?</h3>
<ul>
<li>An operator is on vacation or leaving the organisation</li>
<li>A new team member joins and shares the unsealing responsibilities</li>
<li>The team wants to increase theshards and threshold of unsealing keys</li>
<li>Compliance mandates rotating the encryption keys periodically</li>
</ul>
<h3 id="possible-solutions">Possible Solutions:</h3>
<ul>
<li>Rekey the unsealing keys</li>
<li>Rotate the encryption key</li>
<li>Migrate to auto-unseal</li>
</ul>
<blockquote>
<p><strong>Transfer the unsealing responsibilities.</strong></p>
</blockquote>
<h3 id="explore-the-rekey-and-rotation-method">Explore the rekey and rotation method</h3>
<ul>
<li><strong><code>dev-x-encoded.asc</code></strong></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr7vURYJKwYBBAHaRw8BAQdAbs7pgAejCRBNnJu/ljyFBvKvka7ipnRof+ti
fgA6h+e0G2Rldi14IDxkZXYteEB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEx+DS
/UcaKsnx22UgvoGy1kjA3ywFAmK+71ECGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQvoGy1kjA3ywnYgEAk+OYqhhGiSv6311WzCRV/IPZldgO
f0bk+wb7YHw6Z2MA/idvU4EAV5qvG3nvzX1BkMZU+RIfkluMR03aG6JoexYFuDgE
Yr7vURIKKwYBBAGXVQEFAQEHQBwBNRy1OdcfIrjcVFswZqqZm5go1BLammm+yazS
+SNEAwEIB4h+BBgWCgAmFiEEx+DS/UcaKsnx22UgvoGy1kjA3ywFAmK+71ECGwwF
CQPCZwAACgkQvoGy1kjA3yztzwD/azc7Mrg4DkvFk2dsGeCm9fFCjNOAK5KYDpC5
zXuFp3wBAM61CBVuMVmu+xGrfEvka4cLFy83W8CwzRd2Pa01/5sH
=LqfI
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<ul>
<li><code>dev-y-encoded.asc</code></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr70xBYJKwYBBAHaRw8BAQdARciLwv4WRskXRrNpm5yBDQlOZnribYn9egut
D0jO+OG0G2Rldi15IDxkZXYteUB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEkIMR
wMAjc0Rklkz+HwT+dJXNVcwFAmK+9MQCGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQHwT+dJXNVcyzaQEA5jei8Svjqzs4wU/+VpVisgTwgse6
v1+wuxLkKJFfSFcA/29esVLpbc+S8uXlMj2dEbd3yKg7prbqale3DK24bEoMuDgE
Yr70xBIKKwYBBAGXVQEFAQEHQBYwyIY0D7Pe2F18yn7CNYnBd9uqtN3yReXTtI1t
ESsyAwEIB4h+BBgWCgAmFiEEkIMRwMAjc0Rklkz+HwT+dJXNVcwFAmK+9MQCGwwF
CQPCZwAACgkQHwT+dJXNVcxHCwEAx8M/eUWAr3kmz3YSsAl1pR26o7tBLiuahtVd
nq38ntkBALmrtPzD9hSiEVR+hJaSAgN01KXmwEsvvrQSHXhHpGQM
=WIul
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<ul>
<li><strong><code>dev-z-encoded.asc</code></strong></li>
</ul>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYr703RYJKwYBBAHaRw8BAQdA9QV2avIfeVHy72z6h2rIVlRePBiuyjdaLh4H
nRTL8xu0G2Rldi16IDxkZXYtekB2YXVsdGRlbW8uY29tPoiZBBMWCgBBFiEEjVBp
XY3YIsd3YD2KMQtnpoP/bhwFAmK+9N0CGwMFCQPCZwAFCwkIBwICIgIGFQoJCAsC
BBYCAwECHgcCF4AACgkQMQtnpoP/bhzP9AEAmiIoe09CMqyD4HztKhjbrnMG5C/w
xn3QM6gycJsRI94BANIttzCnAJTymNwkm+PJtHemI5sVq17DZytfCuBTh6kLuDgE
Yr703RIKKwYBBAGXVQEFAQEHQNETh+oi8848nudzbicVPBfA0FcUqtfU5S3oFDer
2m12AwEIB4h+BBgWCgAmFiEEjVBpXY3YIsd3YD2KMQtnpoP/bhwFAmK+9N0CGwwF
CQPCZwAACgkQMQtnpoP/bhzBhwEAk2KC8A/+wesH5NImZvlngee2gDM+WtvFnGyJ
s7MaHDIA/AsFDQenANjqtUuek/y5nzBlMcZAQ5u3Nb12Fb4glNIC
=1hNn
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>
<pre><code>## start the rekeying
vault operator rekey -tls-skip-verify -init -key-shares=3 -key-threshold=2 -pgp-keys=&quot;dev-x-encoded.asc,dev-y-encoded.asc,dev-z-encoded.asc&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_3.png" title="Body image" /></p>
<pre><code>nonce id: d26464d0-1ecb-84fc-25f1-780bd9caf3a
</code></pre>
<pre><code>## Enter the unseal keys
vault operator rekey -tls-skip-verify


vault operator rekey -tls-skip-verify
Rekey operation nonce: d26464d0-lecb-84fc-25f1-7b80bd9caf3a
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_4.png" title="Body image" /></p>
<pre><code>### unseal keys
Key 1 fingerprint: c7e0d2f471a2ac9f1db6520be81b2d648c0df2c; value: wU4DBdRFLivxYlwSAQdAqVEjrKh
Key 2 fingerprint: 908311c0c023734464964cfelf04fe7495cd55cc; value: wU4Dn2PrEmM8HCASAQdAsT1UVfH
Key 3 fingerprint: 8d50695d8dd822c777603d8a310b67a683ff6e1c; value: wU4DkFPOxIC1ZOSAQdAAZoMesq
</code></pre>
<h3 id="rekeying">Rekeying</h3>
<blockquote>
<p>Online process, so no downtime</p>
</blockquote>
<p><img alt="Alt Image Text" src="../../images/chap6_1_5.png" title="Body image" /></p>
<p><strong>Rotating</strong></p>
<pre><code>vault operator rekey -tls-skip-verify

Error rotating key: Error making API request.
URL: POST https: //ab3302c5d721442a389c0e666b55e046-1966045790.us-east-1.elb.amazonaws.com:8200/v1/sys/rotate
Code: 403. Errors:

* permission denied
</code></pre>
<h3 id="generate-a-new-root-token"><strong>Generate a new root token..</strong></h3>
<pre><code>vault operator generate-root-tls-skip-verify -init

Nonce.  da76c47a-9821-97a8-4a42-c9530364d5a4
Started true
Progress 0/2
Complete  false
OTP    gOkDVGzGc3a04kAUUxzs5JK1Tg1m
OT Length 28
</code></pre>
<pre><code>vault operator generate-root -tls-skip-verify
Operation nonce: da76c47a-9821-97a8-4a42-c9530364d5a4
</code></pre>
<pre><code>echo wU4Dn2PrE..  | base64 --decode | gpg -dq

382492d0353209ee28bd05dc96f42aee2b62e2c62c1f18579c67ec3053317b47fd
</code></pre>
<pre><code>vault operator generate-root-tls-skip-verify
Operation nonce: da76c47a-9821-97a8-4a42-c9530364d5a4
Unseal Key (will be hidden) :
Nonce       da76c47a-9821-97a8-4a42-c9530364d5a4
Started     true
Progress    1/2
Complete    false

vault operator generate-root -tls-skip-verify
Operation nonce:   da76c47a-9821-97a8-4a42-c9530364d5a4
Unseal Key (will be hidden):
Nonce       da76c47a-9821-97a8-4a42-c9530364d5a4
Started  true
Progress    2/2
Complete    true
Encoded Token DzkYaj5zAigwQVByYgg5BjQuFj1YKyJZYwwCAg
</code></pre>
<pre><code>nonce id: d26464d0-1ecb-84fc-25f1-780bd9caf3a

decoded = DzkYai5zAiaWOVByYgg5BiQuFilYKyJZYwwCAg
</code></pre>
<pre><code>vault operator generate-root -tls-skip-verify -decode=DzkYai5zAiaWOVByYgg5BiQuFilYKyJZYwwCAg -otp= gOkDVGzGc3a04kAUUxzs5JK1Tg1m
</code></pre>
<h3 id="set-the-new-token">set the new token</h3>
<pre><code>vault login -tls-skip-verify

Key     Value
token   hvs.h4xour1BVcxSaVlJmaih7k30
...
</code></pre>
<h3 id="start-the-key-rotation">Start the key rotation</h3>
<pre><code>vault operator rotate -tls-skip-verify

Success! Rotated key
Key Term.     3
Install Time    02 Jul 22 04:42 UTC
Encryption Count     2
</code></pre>
<h3 id="automate-the-rotation">Automate the rotation</h3>
<pre><code>vault read -tls-skip-verify sys/rotate/config

Key                 Value
enabled     true
interval        0
max_operations  3865470566
</code></pre>
<pre><code>vault read -tls-skip-verify sys/rotate/config 

vault write -tls-skip-verify sys/rotate/config interval=3600h

vault write -tls-skip-verify sys/rotate/config max_operations=&quot;&quot;
</code></pre>
<h2 id="3-auto-unsealing"><strong>3 Auto Unsealing</strong></h2>
<p><img alt="Alt Image Text" src="../../images/chap6_1_6.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap6_1_7.png" title="Body image" /></p>
<blockquote>
<p>Attach this to vault's AM role..</p>
</blockquote>
<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
          &quot;Effect&quot;: &quot;Allow&quot;,
          &quot;Action&quot;: [
            &quot;kms: Encrypt&quot;,
            &quot;kms: Decrypt&quot;,
            &quot;kms: DescribeKey&quot;
          ],
          &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>
<ul>
<li><strong><code>values.yaml</code></strong></li>
</ul>
<pre><code># Vault Helm Chart Value Overrides
global:  
  enabled: true  
  tlsDisable: false

server:

  readinessProbe:
    enabled: true
    path: &quot;/v1/sys/health?standbyok=true&amp;sealedcode=204&amp;uninitcode=204&quot;
  livenessProbe:
    enabled: true
    path: &quot;/v1/sys/health?standbyok=true&quot;
    initialDelaySeconds: 60

  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/vault-tls/vault.ca
    VAULT_SKIP_VERIFY: true

  extraVolumes:
    - type: secret
      name: vault-tls

  standalone:
    enabled: &quot;true&quot;

    # config is a raw string of default configuration when using a Stateful
    # deployment. Default is to use a PersistentVolumeClaim mounted at /vault/data
    # and store data there. This is only used when using a Replica count of 1, and
    # using a stateful set. This should be HCL.

    # Note: Configuration files are stored in ConfigMaps so sensitive data
    # such as passwords should be either mounted through extraSecretEnvironmentVars
            # tls_client_ca_file = &quot;/vault/userconfig/vault-tls/vault.ca&quot;
    # or through a Kube secret.  For more information see:
    # https://www.vaultproject.io/docs/platform/k8s/helm/run#protecting-sensitive-vault-configurations
    config: |

      listener &quot;tcp&quot; {
        address = &quot;[::]:8200&quot;
        cluster_address = &quot;[::]:8201&quot;
        tls_cert_file = &quot;/vault/userconfig/vault-tls/vault.crt&quot;
        tls_key_file  = &quot;/vault/userconfig/vault-tls/vault.key&quot;

      }
      seal &quot;awskms&quot;
      {
        region     = &quot;us-east-1&quot;
        kms_key_id = &quot;b7576d39-d159-46f4-b84b-33f5b618fce2&quot;

      }

      storage &quot;consul&quot; {
        path = &quot;vault&quot;
        address = &quot;consul-consul-server:8500&quot;
      }
      ui = true
      log_level = &quot;Debug&quot;


  service:
    type: LoadBalancer
    annotations: |
      &quot;service.beta.kubernetes.io/aws-load-balancer-name&quot;: &quot;vault-server&quot;
</code></pre>
<pre><code>### Stop the vault server
kubectl scale statefulsets -n vault vault --replicas=0

### update vault helm deployment
helm upgrade vault hashicorp/vault \
  --namespace vault \
  --values values.yaml

### Start vault server 
kubectl scale statefulsets -n vault vault --replicas=1
</code></pre>
<pre><code>$ vault status -tls-skip-verify

Key                  Value
---                   ----
Recovery Seal Type      shamir
....
Storage Type            consul
</code></pre>
<h3 id="migrate-the-seal">Migrate the seal</h3>
<pre><code>vault operator unseal -tls-skip-verify -migrate
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_8.png" title="Body image" /></p>
<pre><code>### restart vault
kubectl delete pods -n vault vault-0

### check the pods
kubectl get pods -n vault -w
</code></pre>
<h2 id="associating-policies">Associating Policies</h2>
<h3 id="root-token">Root Token</h3>
<p><img alt="Alt Image Text" src="../../images/chap6_1_9.png" title="Body image" /></p>
<ul>
<li><strong><code>dev-y-policy.hcl</code></strong></li>
</ul>
<pre><code># List, create, update, and delete key/value secrets
path &quot;secret/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# List, create, update, and delete key/value secrets at kv-v2/ path
path &quot;kv-v2/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}
path &quot;kv/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}
# Deny access to developer z's secret 
path &quot;secret/data/dev-z-secret&quot; 
{
    capabilities = [&quot;deny&quot;]
}

# Manage secrets engines
path &quot;sys/mounts/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# Create and manage ACL policies
path &quot;sys/policies/acl/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;list&quot;]
}
</code></pre>
<ul>
<li><strong><code>dev-z-policy.hcl</code></strong></li>
</ul>
<pre><code># List, create, update, and delete key/value secrets
path &quot;secret/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# Deny access to developer z's secret 
path &quot;secret/data/dev-y-secret&quot; 
{
    capabilities = [&quot;deny&quot;]
}

# Manage secrets engines
path &quot;sys/mounts/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# Create and manage ACL policies
path &quot;sys/policies/acl/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}
</code></pre>
<h3 id="create-or-update-a-policy">create or update  a policy</h3>
<pre><code>vault policy write -tls-skip-verify dev-y-policy policy/dev-y-policy.hcl

Success! Uploaded policy: dev-y-policy

vault policy write -tls-skip-verify dev-z-policy policy/dev-z-policy.hcl

Success! Uploaded policy: dev-z-policy
</code></pre>
<pre><code>## List all policies
vault policy list -tls-skip-verify

default
dev-y-policy
root
</code></pre>
<h3 id="read-the-policy">Read the policy</h3>
<pre><code>vault policy read -tls-skip-verify dev-y-policy 
</code></pre>
<h3 id="generate-a-token-for-the-policy">Generate a token for the policy</h3>
<pre><code>vault token create -tls-skip-verify -format=json -policy=&quot;dev-y-policy&quot; -ttl 1h -use-limit=2

....
hvs.xxxx
</code></pre>
<h3 id="authenticate-with-that-token">Authenticate with that token</h3>
<pre><code>export VAULT_TOKEN=&quot;&quot;
</code></pre>
<p><strong>or</strong></p>
<pre><code>vault login -tls-skip-verify
</code></pre>
<pre><code>$ vault kv list -tls-skip-verify secret/Keys

dev-y-secret
dev-z-secret
my-secret
</code></pre>
<pre><code>vault kv get -tls-skip-verify secret/my-secret
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_10.png" title="Body image" /></p>
<pre><code>vault kv get -tls-skip-verify secret/dev-z-secret
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap6_1_11.png" title="Body image" /></p>
<h3 id="root-token_1">Root Token</h3>
<ul>
<li>Can do anything</li>
<li>Never expires</li>
<li>Should be revoked after initial setup</li>
<li>Should be generated on the fly</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>