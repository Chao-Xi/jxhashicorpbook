
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault3/4encryption_key/">
      
      
        <link rel="prev" href="../3deploy_valut/">
      
      
        <link rel="next" href="../5conf_ha/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>L4 Managing Encryption and Seal Keys - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l4-managing-encryption-and-seal-keys" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L4 Managing Encryption and Seal Keys
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/3vault_rotate/" class="md-nav__link">
        L3 透过 Vault 定期 rotate credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          L4 Managing Encryption and Seal Keys
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        L4 Managing Encryption and Seal Keys
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-vault-encryption-keys" class="md-nav__link">
    1 Vault Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-seal-options" class="md-nav__link">
    3 Seal Options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-vault-initialization-commands" class="md-nav__link">
    4 Vault Initialization Commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#securing-key-shares" class="md-nav__link">
    Securing Key Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal-vault-process-and-commands" class="md-nav__link">
    Unseal Vault Process and Commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal-vault" class="md-nav__link">
    Unseal Vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-vault-server" class="md-nav__link">
    Initializing Vault Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsealing-vault-server" class="md-nav__link">
    Unsealing Vault Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-unseal-overview" class="md-nav__link">
    Auto Unseal Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-unseal-configuration-and-migration" class="md-nav__link">
    Auto Unseal Configuration and Migration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrating-the-vault-seal" class="md-nav__link">
    Migrating the Vault Seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-encryption-keys" class="md-nav__link">
    Managing Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-root-tokens" class="md-nav__link">
    Managing Root Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rotating-the-encryption-keys" class="md-nav__link">
    Rotating the Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-summary" class="md-nav__link">
    Module Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../8vaba_monitor/" class="md-nav__link">
        L8 Configuring Auditing and Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/3vault_tf_nd/" class="md-nav__link">
        L3 Integrating Vault with Terraform & Nomad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/1encrypt_key/" class="md-nav__link">
        L1 Managing the Encryption Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-vault-encryption-keys" class="md-nav__link">
    1 Vault Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-seal-options" class="md-nav__link">
    3 Seal Options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-vault-initialization-commands" class="md-nav__link">
    4 Vault Initialization Commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#securing-key-shares" class="md-nav__link">
    Securing Key Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal-vault-process-and-commands" class="md-nav__link">
    Unseal Vault Process and Commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal-vault" class="md-nav__link">
    Unseal Vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-vault-server" class="md-nav__link">
    Initializing Vault Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsealing-vault-server" class="md-nav__link">
    Unsealing Vault Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-unseal-overview" class="md-nav__link">
    Auto Unseal Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-unseal-configuration-and-migration" class="md-nav__link">
    Auto Unseal Configuration and Migration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrating-the-vault-seal" class="md-nav__link">
    Migrating the Vault Seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-encryption-keys" class="md-nav__link">
    Managing Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-root-tokens" class="md-nav__link">
    Managing Root Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rotating-the-encryption-keys" class="md-nav__link">
    Rotating the Encryption Keys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-summary" class="md-nav__link">
    Module Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l4-managing-encryption-and-seal-keys"><strong>L4 Managing Encryption and Seal Keys</strong></h1>
<h3 id="1-vault-encryption-keys"><strong>1 Vault Encryption Keys</strong></h3>
<p><strong>Vault Logical Architecture</strong></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_1.png" title="Body image" /></p>
<p><strong>Encryption Keys</strong></p>
<p>The data stored by Vault server is important and sensitive, which means you need to protect it in some way.</p>
<p>We're going to be focusing on the storage back end of the Vault logical architecture and the encryption keys that are used to encrypt data that leaves the barrier on its way to the storage back end.</p>
<p><strong>Anything that gets written to persistent storage needs to be encrypted</strong></p>
<p><strong>1 - Encryption keys</strong></p>
<ul>
<li>Protect data written to storage</li>
<li>Stored on disk</li>
</ul>
<p>The first one is the encryption keys themselves that are used to protect data that's been written to persistent storage.</p>
<p>Before that data leaves the barrier that's running in memory, it gets encrypted by the encryption keys and then written out to persistent storage.</p>
<p>they live is on disk. They are written to the same persistent storage that <strong>the regular Vault data is, which means you need a way to encrypt the encryption keys.</strong></p>
<p><strong>2 - Master key</strong></p>
<ul>
<li>Protects encryption keys</li>
<li>Stored on disk</li>
</ul>
<p>The key that encrypts the encryption keys is the master key.</p>
<p><strong>The master key's job is to protect the encryption keys. When Vault loads up, it will load the encryption keys and decrypt them with the master key.</strong></p>
<p>And when the encryption keys are updated, they will be encrypted with the master key before they're written out to persistent storage.</p>
<p>The master key is also stored on disk, which means you need to be able to encrypt that master key.</p>
<p><strong>3 - Unseal key</strong></p>
<ul>
<li>Protects master key</li>
<li>Stored as shares or externally</li>
</ul>
<p>And the key that protects the master key is the unseal key.</p>
<p><strong>When you unseal Vault, you're using the unseal key to decrypt the master key</strong>.</p>
<p>You can either store it as shares or you can store it on some sort of external service.</p>
<p><strong>3 Seal Options</strong></p>
<h3 id="3-seal-options"><strong>3 Seal Options</strong></h3>
<p><strong>1 Shamir secret sharing</strong></p>
<p>Shamir Secret Sharing. <strong>This is an algorithm that Vault uses, and what it does is take a single key, the unseal key, and break it into one or more key shares</strong> and then those shares can be combined back together to recreate the unseal key.</p>
<ul>
<li>Key shares</li>
<li>Required threshold</li>
</ul>
<p>So you could break it into five shares and only require three of those shares to reassemble the key</p>
<p>If you're going to use Shamir Secret Sharing for your seal, <strong>that is something that is configured during the initialization process for Vault</strong>.</p>
<p>It can also be updated with a <strong>rekey option</strong> if you want to change the threshold or the number of key shares.</p>
<ul>
<li>Configured at initialization</li>
<li>Used for sensitive operations</li>
</ul>
<p>In addition to being used to unseal the vault, these key shares are also used for sensitive operations</p>
<p><strong>Something like creating a new root token where you don't want a single individual responsible for that operation, you want to have a threshold of people involved in that operation</strong></p>
<p><strong>2 Auto unseal</strong></p>
<p>This could be a cloud key management <strong>service like Azure Key Vault or AWS KMS, or it could be a hardware security module that exists in your data center</strong>.</p>
<p>The point is it's not stored within Vault</p>
<ul>
<li>External service</li>
<li>Recovery key shares</li>
</ul>
<p><strong>The key shares actually still play a role because you'll need them for sensitive operations.</strong> So the key shares that you may have had for Shamir Secret Sharing get converted to recovery key shares instead.</p>
<ul>
<li>Set by Vault server configuration</li>
</ul>
<p><strong>If you want to use auto unseal for your Vault configuration</strong>, that's actually defined in the Vault server configuration files.</p>
<p><strong>3 Seal Migration</strong></p>
<p><strong>You can migrate the seal from Shamir Secret Sharing to auto unseal. You can migrate it back, or you can migrate to different services within the auto unseal family</strong>.</p>
<p>There's a lot of options when it comes to seal migration. It does require some downtime to make that migration happen, but it is possible to migrate from one type of seal to another without any data loss.</p>
<h3 id="4-vault-initialization-commands"><strong>4 Vault Initialization Commands</strong></h3>
<pre><code># Get Vault server status
vault status
</code></pre>
<pre><code># Initialize Vault server
vault operator init [options]
vault operator init-key-shares=5-key-threshold=3
vault operator init-recovery-shares=5-recovery-threshold=3
</code></pre>
<pre><code>$ vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.12.1
Build Date      2022-10-27T12:32:05Z
Storage Type    inmem
Cluster Name    vault-cluster-5c0ec65d
Cluster ID      128570e3-5c75-fb9c-23fb-12582d9be108
HA Enabled      false
</code></pre>
<h3 id="securing-key-shares"><strong>Securing Key Shares</strong></h3>
<p><strong>When you initialize Vault, the output is going to include the unsealed keys And if you don't specify some type of encryption, they will be printed out in cleartext.</strong></p>
<p><strong>It would be better if you could encrypt each of the unsealed keys using an administrator's public key.</strong></p>
<p>Let's say you have three administrators that you want to be responsible for elevated operations and unsealing Vault.</p>
<p>Each of those administrators can create a public/private key pair and give you the public key to use for encryption.</p>
<p>When you as the operator run the initialization process, you'll feed in those three public keys to encrypt the unsealed keys that are part of the output.</p>
<p>The initialization process will create the unsealed keys</p>
<p><strong>Once those unsealed keys have been created, they'll go back through the initialization process, be encrypted using the public keys that you supplied, and then you can give those encrypted unsealed keys back to your administrators</strong>.</p>
<p>They have the private key pair, so they'll be able to decrypt the encrypted unsealed key and use it when they need to</p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_2.png" title="Body image" /></p>
<h3 id="unseal-vault-process-and-commands"><strong>Unseal Vault Process and Commands</strong></h3>
<p><strong>Unsealing Vault</strong></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_3.png" title="Body image" /></p>
<p>When you start up Vault server, it forms a barrier within memory, and that's where data can live unencrypted.</p>
<p>The data is living in persistent storage, and that includes things like <strong><code>&lt;mark&gt;</code>the master key, which has been encrypted using the unseal key<code>&lt;/mark&gt;</code></strong>, and <strong><code>&lt;mark&gt;</code>the encryption keys, which have been encrypted using the master key<code>&lt;/mark&gt;</code></strong></p>
<p><strong>The persistent data itself, which has been encrypted with the encryption keys</strong></p>
<p><strong>When you want to unseal the vault, each stakeholder will submit their unseal key until you've reached the threshold.</strong></p>
<p>They'll send those to the API, either through the CLI, the UI or the API directly. And then Vault will assemble those keys into the unseal key that lives only in memory.</p>
<p><strong>The unseal key is never written out to persistent storage.</strong></p>
<p><strong>And then Vault will load the master key and use the unseal key to decrypt it, and then it will load the encryption keys and use the master key to decrypt those</strong></p>
<p>Now Vault is ready to start servicing requests because it has all the necessary ingredients to decrypt persistent data that is on the storage back end.</p>
<h3 id="unseal-vault"><strong>Unseal Vault</strong></h3>
<pre><code># Start unseal process
vault operator unseal [options] [KEY]

# Seal an unsealed Vault server
vault operator seal [options]
</code></pre>
<p>Now this command needs to be run multiple times until you hit the threshold for key shares so Vault can reassemble the unseal key</p>
<p>Once it has hit that threshold, Vault will assemble the unseal key, and it will unseal the vault.</p>
<h3 id="initializing-vault-server"><strong>Initializing Vault Server</strong></h3>
<ul>
<li>Initialize Vault with GPG keys</li>
<li>Unseal Vault and verify</li>
<li>Log into Vault with root token</li>
</ul>
<p>We are going to initialize and unseal the Vault server using PGP keys from our admins!</p>
<pre><code>#Install GnuPG and rng-tools
sudo apt install gnupg rng-tools -y
sudo rngd -r /dev/urandom
</code></pre>
<p><strong>Configure <code>GPG_TTY</code></strong></p>
<pre><code>GPG_TTY=$(tty)
export GPG_TTY
</code></pre>
<p>First we have to generate our pgp keys using gpg</p>
<pre><code>gpg --batch --gen-key vaultadmin1
gpg --batch --gen-key vaultadmin2
gpg --batch --gen-key vaultadmin3
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_4.png" title="Body image" /></p>
<p>Now we need the base64 encoded public keys to use with Vault</p>
<pre><code>gpg --export vaultadmin1 | base64 &gt; vaultadmin1.asc
gpg --export vaultadmin2 | base64 &gt; vaultadmin2.asc
gpg --export vaultadmin3 | base64 &gt; vaultadmin3.asc
</code></pre>
<p>Now we can initialize the seal with our gpg keys</p>
<p><strong><code>vaultadmin1</code></strong></p>
<pre><code>Key-Type: 1
Key-Length: 2048
Subkey-Type: 1
Subkey-Length: 2048
Name-Real: vaultadmin1
Passphrase: vaultpassphrase
Expire-Date: 0
</code></pre>
<p><strong><code>vaultadmin2</code></strong></p>
<pre><code>Key-Type: 1
Key-Length: 2048
Subkey-Type: 1
Subkey-Length: 2048
Name-Real: vaultadmin2
Passphrase: vaultpassphrase
Expire-Date: 0
</code></pre>
<p><strong><code>vaultadmin3</code></strong></p>
<pre><code>Key-Type: 1
Key-Length: 2048
Subkey-Type: 1
Subkey-Length: 2048
Name-Real: vaultadmin3
Passphrase: vaultpassphrase
Expire-Date: 0
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_5.png" title="Body image" /></p>
<pre><code>export VAULT_ADDR=&quot;https://YOUR_VAULT_FQDN:8200&quot;
vault operator init -key-shares=3 -key-threshold=2 -pgp-keys=&quot;vaultadmin1.asc,vaultadmin2.asc,vaultadmin3.asc&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_6.png" title="Body image" /></p>
<pre><code>$vault operator init
-key-shares=3 -key-threshold=2 -pgp-keys=&quot;vaultadmin1.asc, vaultadmin2. asc, vaultadmin3.asc&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_7.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_8.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_9.png" title="Body image" /></p>
<p><strong>Copy out the key values to <code>seal_keys.txt</code></strong></p>
<p>Next up, we are going to unseal our Vault server</p>
<pre><code>#Decrypt the first two keys
echo &quot;UNSEAL_KEY_1&quot; | base64 --decode | gpg -u vaultadmin1 -dq
echo &quot;UNSEAL_KEY_2&quot; | base64 --decode | gpg -u vaultadmin2 -dq
</code></pre>
<ul>
<li><code>UNSEAL_KEY_1 = wcBMA......</code></li>
<li><code>UNSEAL_KEY_2 = wcBMA......</code></li>
</ul>
<p><img alt="Alt Image Text" src="../../images/vt3_4_10.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_12.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_11.png" title="Body image" /></p>
<h3 id="unsealing-vault-server"><strong>Unsealing Vault Server</strong></h3>
<pre><code>#Unseal the vault
vault operator unseal  
...
(Unseal key decrypted 1)


vault operator unseal  
...
(Unseal key decrypted 2)
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_14.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_13.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_15.png" title="Body image" /></p>
<pre><code># Login into Vault
vault login
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_16.png" title="Body image" /></p>
<ul>
<li>Enable auto unseal with Azure Key Vault</li>
<li>Revoke the current root token</li>
<li>Rotate the current encryption keys</li>
</ul>
<h3 id="auto-unseal-overview"><strong>Auto Unseal Overview</strong></h3>
<ul>
<li>Unseal key stored in secure location</li>
</ul>
<p>The big idea behind auto unseal is when the Vault server comes up, it can automatically unseal itself, <strong>assuming it has access to the external location where the unseal key is stored.</strong></p>
<p>It could be stored in a cloud service <strong>like Azure Key Vault. It could be stored in an on‑premises HSM, or you can actually use the Vault transit engine on a different instance of Vault</strong></p>
<p>Now the way that keys are typically stored in cloud services and HSMs is that the private key cannot leave that secured location, <strong>which means what Vault needs to do is take the encrypted master key, which has been encrypted using the unseal key, submit that master key to the service, and ask it to decrypt the master key and send the decrypted master key back.</strong></p>
<ul>
<li>Cloud services, HSM, Vault transit engine</li>
<li>Master key submitted to secure location</li>
<li>Key shares become recovery keys</li>
</ul>
<p>Once you've selected auto unseal, <strong>the key shares that you would normally have from an unsealed key become recovery keys</strong>, and they <strong>can be used for sensitive operations like rekeying the vault or creating a new root token</strong>.</p>
<ul>
<li>Key shares still required</li>
</ul>
<p><strong>We associated an Azure AD Managed Service Identity with that Azure VM, which is how it accesses Azure Key Vault to get the certificate it's using for the Vault configuration.</strong></p>
<p>We can also use that same identity to store a key in Azure Key Vault for auto unseal, and the Azure VM will be able to use that identity to perform the necessary operations to decrypt the master key.</p>
<p><strong>Auto Unseal Architecture</strong></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_17.png" title="Body image" /></p>
<h3 id="auto-unseal-configuration-and-migration">Auto Unseal Configuration and Migration</h3>
<p><strong><code>Vault-Config.hcl</code></strong></p>
<pre><code>seal &quot;azurekeyvault&quot; {
    tenant_id = &quot;00000-00000-00000-00000&quot;
    vault_name = &quot;key-vault-name&quot;
    key_name = &quot;key-name-in-key-vault&quot; 
}
</code></pre>
<p><strong>Seal Migration Process</strong></p>
<ul>
<li>Update the Vault configuration</li>
<li>Restart Vault to seal and update configuration</li>
<li>Unseal Vault with the migrate flag</li>
</ul>
<p>It starts with the seal keyword and then the type of seal you want to implement. In our case, we're implementing azurekeyvault.</p>
<p>For Azure Key Vault, we need to specify the <code>tenant_id</code>, we need to specify the name of the key vault where we're going to be storing the key, and we also need to specify the name of the key that's stored in Key Vault that will be used for the auto unseal operation.</p>
<p>If we were not using managed security identities, we would also have to specify a client ID and client secret in this configuration, but fortunately, Vault can just take advantage of that managed security identity associated with the Azure virtual machine</p>
<pre><code>#Log into Azure with CLI
az login
az account set --subscription &quot;SUB_NAME&quot;
</code></pre>
<pre><code>cp auto_unseal_key.txt auto_unseal_key.tf
</code></pre>
<p><strong><code>auto_unseal_key.txt</code></strong></p>
<pre><code>locals {
  unseal_key_name = &quot;vault-${random_id.id.hex}&quot;
}

resource &quot;azurerm_key_vault_key&quot; &quot;unseal_key&quot; {
  name         = local.unseal_key_name
  key_vault_id = azurerm_key_vault.vault.id
  key_type     = &quot;RSA&quot;
  key_size     = 2048

  key_opts = [
    &quot;decrypt&quot;,
    &quot;encrypt&quot;,
    &quot;sign&quot;,
    &quot;unwrapKey&quot;,
    &quot;verify&quot;,
    &quot;wrapKey&quot;,
  ]
}

resource &quot;local_file&quot; &quot;seal_config&quot; {
  filename = &quot;${path.module}/seal.hcl&quot;
  content = &lt;&lt;EOF
seal &quot;azurekeyvault&quot; {
  tenant_id      = &quot;${data.azurerm_client_config.current.tenant_id}&quot;
  vault_name     = &quot;${azurerm_key_vault.vault.name}&quot;
  key_name       = &quot;${azurerm_key_vault_key.unseal_key.name}&quot;
}
  EOF
}
</code></pre>
<pre><code># Now we can run a Terraform plan and apply with the same values as before
certificate_cn=YOUR_CERTIFICATE_CN

$ certificate_cn=vault-vms.globomantics.xyz
</code></pre>
<pre><code>terraform plan -var leader_tls_servername=$certificate_cn -out azurevm.tfplan

# Now we'll apply the plan to create the resources
terraform apply azurevm.tfplan
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_18.png" title="Body image" /></p>
<p><strong>New file created <code>seal.hcl</code></strong></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_19.png" title="Body image" /></p>
<p>Next step is to update the Vault server configuration to use Key Vault for the seal Connect to the Azure VM via SSH to update the HCL file</p>
<pre><code>ssh -i ~/.ssh/azure_vms_private_key.pem azureuser@PUBLIC_IP_ADDRESS

ssh -i ~/.ssh/azure vms private key.pem azureuser@20.72.146.101
</code></pre>
<pre><code># Edit the vault.hcl file
sudo vi /etc/vault.d/vault.hcl
</code></pre>
<p>Paste seal key part</p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_20.png" title="Body image" /></p>
<pre><code># Now we will restart Vault to seal it and update the loaded config
# then unseal with the migrate flag
sudo systemctl restart vault

exit
</code></pre>
<h3 id="migrating-the-vault-seal"><strong>Migrating the Vault Seal</strong></h3>
<pre><code># We're going to need our GPG keys to complete the operation
# Decrypt the first two keys if you don't have them anymore
echo &quot;FIRST_KEY&quot; | base64 --decode | gpg -u vaultadmin1 -dq
echo &quot;SECOND_KEY&quot; | base64 --decode | gpg -u vaultadmin2 -dq
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_11.png" title="Body image" /></p>
<pre><code>vault operator unseal -migrate

# FIRST_KEY
# SECOND_KEY
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_21.png" title="Body image" /></p>
<p><strong>Our keys become recovery keys</strong></p>
<h3 id="managing-encryption-keys"><strong>Managing Encryption Keys</strong></h3>
<p><strong>Rekey</strong></p>
<ul>
<li>Update Unseal and Master keys</li>
<li>Change seal settings Rotate</li>
</ul>
<p>What the rekey process does is update both the <strong>unseal key and the master keys</strong>. Now this is only done if you're using Shamir Secret Sharing and not if you've migrated to auto unseal.</p>
<p>You can also use the <strong>rekey operation to change the seal settings, including the number of key shares and the threshold for those key shares.</strong></p>
<p>And that's something you can do whether you're using auto unseal or if you're using Shamir Secret Sharing.</p>
<p><strong>Rotate</strong></p>
<ul>
<li>Update Encryption keyring</li>
<li>Previous versions saved</li>
</ul>
<p>It creates a new version of your encryption keys.</p>
<p><strong>It also saves the previous version of those encryption keys because it doesn't go out and decrypt all of the data and reencrypt it with the new version of the encryption keys</strong>.</p>
<p>Manage Keys</p>
<pre><code># Rekey unseal and master keys
vault operator rekey [options] [KEY]
vault operator rekey –init –key-shares=7 –key-threshold=5

# Check the encryption key status
vault operator key-status [options]

# Rotate the encryption key
vault operator rotate [options]
</code></pre>
<h3 id="managing-root-tokens">Managing Root Tokens</h3>
<ul>
<li>Root token can do ANYTHING</li>
</ul>
<p><strong>The root token can do anything involved. It has full permissions to do anything involved that it wants to do, which makes it pretty dangerous</strong></p>
<p>doesn't have an expiration time on it, so it just lasts forever.</p>
<ul>
<li>Encrypt with PGP</li>
<li>Non-persistent root tokens</li>
</ul>
<p>Now one of the recommendations is when you generate a root token, <strong>you use PGP encryption to protect the output</strong> so only the administrator that's requesting it sees the actual value of that root token. When you're creating a root token, <strong>you should set it to expire or make it non‑persistent</strong>.</p>
<ul>
<li>Generate using key shares</li>
</ul>
<p>The other thing about non‑persistent root tokens is although they can create new root tokens, <strong>those new root tokens are still beholden to the expiration of the original root token</strong>. The process by which you generate a new root token requires the use of key shares because this is also a sensitive and privileged operation.</p>
<p><strong>Manage Root Token</strong></p>
<pre><code># Revoke root token
vault token revoke [options]
vault operator revoke –self
vault operator revoke –accessor=1234567890


# Create new root token
vault operator generate-root [options]
vault operator generate-root –init
vault operator generate-root –nonce=NONCE_VALUE
</code></pre>
<pre><code>#Revoke the existing root token
vault login
vault token revoke -self
vault token lookup
</code></pre>
<pre><code>$vault token revoke&quot;-self
Success! Revoked token (if it existed)

$vault token lookup
Error looking up token: Error making API request.
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_22.png" title="Body image" /></p>
<pre><code>$vault login
Token (will be hidden):
Error authenticating: error looking
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_23.png" title="Body image" /></p>
<pre><code>#Start the root token generation process
vault operator generate-root -init -pgp-key=&quot;vaultadmin1.asc&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_24.png" title="Body image" /></p>
<pre><code>vault operator generate-root -nonce=NONCE_VALUE
</code></pre>
<pre><code>$vault operator generate-root
-nonce=a95edaf3-19fa-a172-a73e-b8baf6219aea
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_25.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_4_26.png" title="Body image" /></p>
<pre><code>echo &quot;ENCODED_TOKEN&quot; | base64 --decode | gpg -u vaultadmin1 -dq
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_27.png" title="Body image" /></p>
<p><strong><code>New Root Token: s.wKzTtgK10ioznctwlZcT1Ghp</code></strong></p>
<pre><code># Try to log in with the new token
vault login
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_28.png" title="Body image" /></p>
<p><strong>Tasks</strong></p>
<ul>
<li>Rotate encryption key</li>
<li>Revoke root token and create new one</li>
</ul>
<h3 id="rotating-the-encryption-keys"><strong>Rotating the Encryption Keys</strong></h3>
<pre><code># Rotate the encryption key
vault operator key-status

vault operator rotate
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_4_29.png" title="Body image" /></p>
<pre><code>terraform destroy -var leader_tls_servername=$certificate_cn -auto-approve
</code></pre>
<h3 id="module-summary"><strong>Module Summary</strong></h3>
<ul>
<li>Vault seal protects the master key that protects the encryption keys</li>
<li>Vault must be initialized and unsealed prior to use</li>
<li>Seal configuration can be migrated</li>
<li>Unseal, master, and encryptions keys should be periodically updated</li>
<li>Root tokens can do anything and should be revoked quickly</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>