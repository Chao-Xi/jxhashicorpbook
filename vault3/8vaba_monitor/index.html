
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault3/8vaba_monitor/">
      
      
        <link rel="prev" href="../7vaba_secret_engine/">
      
      
        <link rel="next" href="../../vault4/1mag_vt_intro/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>L8 Configuring Auditing and Monitoring - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l8-configuring-auditing-and-monitoring" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L8 Configuring Auditing and Monitoring
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/3vault_rotate/" class="md-nav__link">
        L3 透过 Vault 定期 rotate credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4encryption_key/" class="md-nav__link">
        L4 Managing Encryption and Seal Keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          L8 Configuring Auditing and Monitoring
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        L8 Configuring Auditing and Monitoring
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#monitoring-disambiguation" class="md-nav__link">
    Monitoring Disambiguation
  </a>
  
    <nav class="md-nav" aria-label="Monitoring Disambiguation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telemetry" class="md-nav__link">
    Telemetry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditing" class="md-nav__link">
    Auditing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vault-server-logs" class="md-nav__link">
    Vault Server Logs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auditing-on-vault" class="md-nav__link">
    Auditing on Vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-data-capture-and-commands" class="md-nav__link">
    Audit Data Capture and Commands
  </a>
  
    <nav class="md-nav" aria-label="Audit Data Capture and Commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audit-commands" class="md-nav__link">
    Audit Commands
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-device-demo-overview" class="md-nav__link">
    Audit Device Demo Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-workbook-and-extensions" class="md-nav__link">
    Deploying the Workbook and Extensions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-workbook-and-extensions_1" class="md-nav__link">
    Deploying the Workbook and Extensions
  </a>
  
    <nav class="md-nav" aria-label="Deploying the Workbook and Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-local-file-auditing" class="md-nav__link">
    Configuring local file auditing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vault-hardening" class="md-nav__link">
    Vault Hardening
  </a>
  
    <nav class="md-nav" aria-label="Vault Hardening">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-level" class="md-nav__link">
    System level
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    Networking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vault-configuration" class="md-nav__link">
    Vault configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-summary" class="md-nav__link">
    Module Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/3vault_tf_nd/" class="md-nav__link">
        L3 Integrating Vault with Terraform & Nomad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/1encrypt_key/" class="md-nav__link">
        L1 Managing the Encryption Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#monitoring-disambiguation" class="md-nav__link">
    Monitoring Disambiguation
  </a>
  
    <nav class="md-nav" aria-label="Monitoring Disambiguation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telemetry" class="md-nav__link">
    Telemetry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditing" class="md-nav__link">
    Auditing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vault-server-logs" class="md-nav__link">
    Vault Server Logs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auditing-on-vault" class="md-nav__link">
    Auditing on Vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-data-capture-and-commands" class="md-nav__link">
    Audit Data Capture and Commands
  </a>
  
    <nav class="md-nav" aria-label="Audit Data Capture and Commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audit-commands" class="md-nav__link">
    Audit Commands
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audit-device-demo-overview" class="md-nav__link">
    Audit Device Demo Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-workbook-and-extensions" class="md-nav__link">
    Deploying the Workbook and Extensions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-workbook-and-extensions_1" class="md-nav__link">
    Deploying the Workbook and Extensions
  </a>
  
    <nav class="md-nav" aria-label="Deploying the Workbook and Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-local-file-auditing" class="md-nav__link">
    Configuring local file auditing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vault-hardening" class="md-nav__link">
    Vault Hardening
  </a>
  
    <nav class="md-nav" aria-label="Vault Hardening">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-level" class="md-nav__link">
    System level
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    Networking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vault-configuration" class="md-nav__link">
    Vault configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-summary" class="md-nav__link">
    Module Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l8-configuring-auditing-and-monitoring"><strong>L8 Configuring Auditing and Monitoring</strong></h1>
<ul>
<li>Vault server logging</li>
<li>Auditing activity</li>
<li>Hardening Vault server</li>
</ul>
<h2 id="monitoring-disambiguation"><strong>Monitoring Disambiguation</strong></h2>
<p><strong>Monitoring</strong></p>
<h3 id="telemetry">Telemetry</h3>
<p>These are metrics that you collect about your system, how many IOPS your disk system is using, <strong>how much memory is being utilized, how many transactions you can process per minute</strong>. It's about health, and performance, and metrics</p>
<h3 id="logging">Logging</h3>
<p>Then there's logging, and logging is just writing down in a file or in some sort of collection utility what is happening with the system</p>
<p>And the logging can come from the operating system itself, or it could come from the applications that are running on the system.</p>
<p><strong>It is specific to what's happening with those services and that system.</strong></p>
<h3 id="auditing"><strong>Auditing</strong></h3>
<p>Auditing likes to take a look at how users are utilizing the system, what actions they're performing on the system</p>
<h2 id="vault-server-logs">Vault Server Logs</h2>
<ul>
<li>Configuration file, environment variables, or CLI</li>
<li>Writes to standard log locations</li>
<li>Captures Vault server events</li>
</ul>
<p>What is captured in those logs is Vault server events, things like <strong>initializing, unsealing, the generation of root tokens, all things that are happening with the Vault service and its underlying components</strong>.</p>
<ul>
<li>Real time view with monitor command</li>
</ul>
<p>If you want to get a real‑time view of what's going on with the Vault logging, you can run vault monitor and that will pull up a real‑time feed of the Vault logs for whatever you have <code>VAULT_ADDR</code> set to.</p>
<h2 id="auditing-on-vault">Auditing on Vault</h2>
<ul>
<li><strong>Captures all requests and responses through the API</strong></li>
</ul>
<p>Vault auditing is there to capture all the requests and responses that go through the API, and since we know that all interaction with Vault has to happen through the API, that means any clients that want to interact with the Vault service are going to go through that API in the form of requests, and then they will get responses back from the Vault server.</p>
<ul>
<li><strong>Implemented through device types</strong></li>
<li>File, socket, syslog</li>
</ul>
<p>The auditing data is captured by audit devices, and there's a few different device types available to you.</p>
<p><strong>There's the file device type, which writes data to a local file that you indicate.</strong></p>
<p>There's the socket, which will write to a UNIX socket.</p>
<p><strong>And then there's syslog, which will write to syslog, and you can specify options for each of these to customize how the device is handled</strong>.</p>
<ul>
<li><strong>One device MUST be available</strong></li>
<li><strong>Sensitive data hashed</strong></li>
<li>Verified with <code>/sys/audit-hash</code></li>
</ul>
<h2 id="audit-data-capture-and-commands"><strong>Audit Data Capture and Commands</strong></h2>
<p><img alt="Alt Image Text" src="../../images/vt3_8_1.png" title="Body image" /></p>
<ol>
<li>And that API is going to send that <strong>request to Vault Core</strong>, which is behind the barrier.</li>
<li>Behind that barrier, it's going to validate that the developers have access to that secret, and then go to retrieve that secret.</li>
<li>At the same time, <strong>it's going to write that request data to an audit device</strong>.</li>
<li>It's first going to create an audit entry, which is in JSON, and then it's going to <strong>apply a device salt to any sensitive data that's in that entry</strong>, and then finally, write that entry out to the audit device.</li>
<li>Once the audit entry has been successfully written, <strong>Vault will now return that secret data to the developers</strong> and write the response to the audit device as well.</li>
</ol>
<p>In this way, the entire interaction has been captured by the audit device.</p>
<h3 id="audit-commands"><strong>Audit Commands</strong></h3>
<pre><code># Enable audit device
vault audit enable [options] TYPE [settings]
vault audit enable –path=file-audit file file_path=/opt/vault/logs/auditlog

# Disable audit device
vault audit disable PATH
vault audit disable file-audit

# List audit devices
vault audit list [options]
</code></pre>
<ul>
<li>Capture audit logs with Azure Log Analytics</li>
<li>Ensure at least one audit device is available</li>
<li>Sensitive values should not be in clear text</li>
</ul>
<h2 id="audit-device-demo-overview"><strong>Audit Device Demo Overview</strong></h2>
<p><img alt="Alt Image Text" src="../../images/vt3_8_2.png" title="Body image" /></p>
<p>We're going to set up a file type audit device to capture the logs on the local systems that are part of our vault cluster.</p>
<p>Because the local file system should always be available, we can be relatively certain that we're not going to start dropping requests because the audit device is not available, but Globomantics also wants us to capture our audit data with log analytics.</p>
<p>We can do that by setting up a second audit device writing to syslog and then we can use the OMS agent, which is an agent that runs on each Azure VM, to collect the syslog data and send that up to a workspace in log analytics.</p>
<h2 id="deploying-the-workbook-and-extensions"><strong>Deploying the Workbook and Extensions</strong></h2>
<p><strong><code>log_analytics.tf</code></strong></p>
<pre><code>variable &quot;oms_agent_version&quot; {
  type = string
  description = &quot;Version of OMS Linux Agent to install&quot;
  default = &quot;1.13&quot;
}

resource &quot;azurerm_log_analytics_workspace&quot; &quot;vault&quot; {
  name                = local.vault_vm
  location            = azurerm_resource_group.vault.location
  resource_group_name = azurerm_resource_group.vault.name
  sku                 = &quot;PerGB2018&quot;
  retention_in_days   = 30
}

resource &quot;azurerm_virtual_machine_extension&quot; &quot;tfazmon_ext&quot; {
  count = var.vault_vm_count
  name                 = &quot;OmsAgentForLinux-${count.index}&quot;
  virtual_machine_id   = azurerm_linux_virtual_machine.vault[count.index].id
  publisher            = &quot;Microsoft.EnterpriseCloud.Monitoring&quot;
  type                 = &quot;OmsAgentForLinux&quot;
  type_handler_version = var.oms_agent_version
  auto_upgrade_minor_version = true

  settings = &lt;&lt;SETTINGS
    {
        &quot;workspaceId&quot;: &quot;${azurerm_log_analytics_workspace.vault.workspace_id}&quot;
    }
SETTINGS

    protected_settings = &lt;&lt;PROTECTEDSETTINGS
    {
        &quot;workspaceKey&quot;: &quot;${azurerm_log_analytics_workspace.vault.primary_shared_key}&quot;
    }
PROTECTEDSETTINGS
}
</code></pre>
<pre><code>

# Now we'll update our deployment
# Make sure to change the YOUR_CERTIFICATE_CN to the fqdn on
# your TLS certificate. Ex. vault-vms.globomantics.xyz
certificate_cn=YOUR_CERTIFICATE_CN
</code></pre>
<pre><code>terraform plan -var leader_tls_servername=$certificate_cn -out azurevm.tfplan

# Now we'll apply the plan to create the resources
terraform apply azurevm.tfplan
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_8_3.png" title="Body image" /></p>
<p>The next step has to be done in the UI or by altering the syslog config files.</p>
<p><strong>It's easier to go to the UI and update the agent settings to include facility LOCAL7</strong></p>
<p><img alt="Alt Image Text" src="../../images/vt3_8_4.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_8_5.png" title="Body image" /></p>
<pre><code>ssh -i ~/.ssh/azure_vms_private_key2.pem -p 2022 azureuser@20.62.217.163
</code></pre>
<pre><code>ssh -i ~/.ssh/azure vms private kev2.pem -p 2022 azureuser@20.62.217.163
</code></pre>
<pre><code># Check on the config file
sudo cat /etc/rsyslog.d/95-omsagent.conf
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_8_6.png" title="Body image" /></p>
<pre><code># Restart agent if desired
sudo /opt/microsoft/omsagent/bin/service_control restart

# And the wa-agent as well
sudo systemctl restart walinuxagent
</code></pre>
<h2 id="deploying-the-workbook-and-extensions_1">Deploying the Workbook and Extensions</h2>
<h3 id="configuring-local-file-auditing"><strong>Configuring local file auditing</strong></h3>
<p>Head back to this folder</p>
<pre><code># Set your Vault address environment variable
# Ex. vault-vms.globomantics.xyz
export VAULT_ADDR=https://VAULT_SERVER_FQDN:8200


# And log into Vault using the globoadmin user
vault login -method=userpass username=testadmin

# First we need to update our admin policy!
vault policy write vault-admins vault-admins.hcl
</code></pre>
<p><strong><code>vault-admins.hcl</code></strong></p>
<pre><code># Allow managing leases
path &quot;sys/leases/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# Manage auth backends broadly across Vault
path &quot;auth/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# List, create, update, and delete auth backends
path &quot;sys/auth/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;sudo&quot;]
}

# List existing policies
path &quot;sys/policies&quot;
{
  capabilities = [&quot;read&quot;]
}

# Create and manage ACL policies broadly across Vault
path &quot;sys/policies/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# List, create, update, and delete key/value secrets
path &quot;secret/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# Manage and manage secret backends broadly across Vault.
path &quot;sys/mounts/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}

# List existing secret engines.
path &quot;sys/mounts&quot;
{
  capabilities = [&quot;read&quot;]
}

# Read health checks
path &quot;sys/health&quot;
{
  capabilities = [&quot;read&quot;, &quot;sudo&quot;]
}

# Configure auditing
path &quot;sys/audit&quot;
{
  capabilities = [&quot;list&quot;, &quot;sudo&quot;]
}

path &quot;sys/audit/*&quot;
{
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}
</code></pre>
<pre><code># Enable a file location for an audit device
vault audit enable file file_path=/opt/vault/audit.log
</code></pre>
<p>Now go back to the Azure portal and the log analytics workspace we created earlier.</p>
<p>You can query the logs capture and verify that event have started to show up</p>
<p><img alt="Alt Image Text" src="../../images/vt3_8_7.png" title="Body image" /></p>
<pre><code># Run the following query on Logs
Syslog
| where Facility == &quot;local7&quot; 
</code></pre>
<pre><code># Add some entries to the audit log by issuing
# Vault requests
vault secrets list

vault policy list

vault secrets enable -path=audittest kv
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt3_8_8.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt3_8_9.png" title="Body image" /></p>
<h2 id="vault-hardening">Vault Hardening</h2>
<h3 id="system-level">System level</h3>
<ul>
<li>Run unprivileged</li>
<li><strong>That means not running as root</strong>.</li>
<li>When we installed Vault on our Azure Virtual Machines, it already created a Vault user for us, and that is the user that we've used to run the service.</li>
<li>Run single tenant</li>
<li>Disable swap and command history</li>
<li>In the configuration of your operating system, you should try to disable swap and command history.</li>
<li><strong>Swap typically writes memory to some sort of persistent data when it needs to swap out pages of memory</strong>.</li>
<li><strong>Disable core dumps</strong></li>
<li><strong>Protect storage</strong></li>
<li><strong>Use SELinux or AppArmor</strong></li>
</ul>
<h3 id="networking"><strong>Networking</strong></h3>
<ul>
<li>Disable remote access</li>
<li>Restrict network traffic</li>
<li>End-to-end TLS</li>
</ul>
<h3 id="vault-configuration"><strong>Vault configuration</strong></h3>
<ul>
<li>Enable auditing</li>
<li>Avoid root tokens</li>
<li>Immutable and frequent upgrades</li>
</ul>
<h2 id="module-summary"><strong>Module Summary</strong></h2>
<ul>
<li>Vault logging can be set in multiple places and captures server activity.</li>
<li><strong>Auditing captures all requests and responses from the API</strong>.</li>
<li>Sensitive data is hashed by default and can be confirmed with the <strong>audit-hash API endpoint</strong></li>
<li><strong>Apply proper hardening to your Vault servers per HashiCorp and your organization.</strong></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>