
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault5/3vault_tf_nd/">
      
      
        <link rel="prev" href="../2vault_agent/">
      
      
        <link rel="next" href="../4vault_consul/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>L3 Integrating Vault with Terraform & Nomad - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l3-integrating-vault-with-terraform-nomad" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L3 Integrating Vault with Terraform & Nomad
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/3vault_rotate/" class="md-nav__link">
        L3 透过 Vault 定期 rotate credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/4encryption_key/" class="md-nav__link">
        L4 Managing Encryption and Seal Keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/8vaba_monitor/" class="md-nav__link">
        L8 Configuring Auditing and Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          L3 Integrating Vault with Terraform & Nomad
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        L3 Integrating Vault with Terraform & Nomad
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-terraform-integration" class="md-nav__link">
    1 Terraform Integration
  </a>
  
    <nav class="md-nav" aria-label="1 Terraform Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terraform" class="md-nav__link">
    Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-terraform-works" class="md-nav__link">
    How Terraform Works
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-terraform-workflow" class="md-nav__link">
    A Terraform Workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-vault" class="md-nav__link">
    Integration with Vault
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demo-creating-the-vault-root-aws-user" class="md-nav__link">
    Demo: Creating the Vault-Root AWS User
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nomad-integration-tokens" class="md-nav__link">
    Nomad Integration - Tokens
  </a>
  
    <nav class="md-nav" aria-label="Nomad Integration - Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-vs-nomad" class="md-nav__link">
    Kubernetes vs Nomad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-acl-system" class="md-nav__link">
    Nomad ACL System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-start" class="md-nav__link">
    Nomad Start
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nomad-integration-mtls" class="md-nav__link">
    Nomad Integration - mTLS
  </a>
  
    <nav class="md-nav" aria-label="Nomad Integration - mTLS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nomads-communications" class="md-nav__link">
    Nomad’s Communications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-mtls" class="md-nav__link">
    Nomad mTLS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtls-certificate-rotation" class="md-nav__link">
    mTLS Certificate Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-configuring-vault-consul-template" class="md-nav__link">
    Demo: Configuring Vault &amp; Consul-template
  </a>
  
    <nav class="md-nav" aria-label="Demo: Configuring Vault & Consul-template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul-template" class="md-nav__link">
    Consul Template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-configuring-nomad-for-mtls" class="md-nav__link">
    Demo: Configuring Nomad for mTLS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-review" class="md-nav__link">
    Module Review
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/1encrypt_key/" class="md-nav__link">
        L1 Managing the Encryption Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-terraform-integration" class="md-nav__link">
    1 Terraform Integration
  </a>
  
    <nav class="md-nav" aria-label="1 Terraform Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terraform" class="md-nav__link">
    Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-terraform-works" class="md-nav__link">
    How Terraform Works
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-terraform-workflow" class="md-nav__link">
    A Terraform Workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-vault" class="md-nav__link">
    Integration with Vault
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demo-creating-the-vault-root-aws-user" class="md-nav__link">
    Demo: Creating the Vault-Root AWS User
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nomad-integration-tokens" class="md-nav__link">
    Nomad Integration - Tokens
  </a>
  
    <nav class="md-nav" aria-label="Nomad Integration - Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-vs-nomad" class="md-nav__link">
    Kubernetes vs Nomad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-acl-system" class="md-nav__link">
    Nomad ACL System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-start" class="md-nav__link">
    Nomad Start
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nomad-integration-mtls" class="md-nav__link">
    Nomad Integration - mTLS
  </a>
  
    <nav class="md-nav" aria-label="Nomad Integration - mTLS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nomads-communications" class="md-nav__link">
    Nomad’s Communications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nomad-mtls" class="md-nav__link">
    Nomad mTLS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtls-certificate-rotation" class="md-nav__link">
    mTLS Certificate Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-configuring-vault-consul-template" class="md-nav__link">
    Demo: Configuring Vault &amp; Consul-template
  </a>
  
    <nav class="md-nav" aria-label="Demo: Configuring Vault & Consul-template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul-template" class="md-nav__link">
    Consul Template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-configuring-nomad-for-mtls" class="md-nav__link">
    Demo: Configuring Nomad for mTLS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-review" class="md-nav__link">
    Module Review
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l3-integrating-vault-with-terraform-nomad"><strong>L3 Integrating Vault with Terraform &amp; Nomad</strong></h1>
<h2 id="1-terraform-integration"><strong>1 Terraform Integration</strong></h2>
<p><strong>Module Overview</strong></p>
<ul>
<li>Dynamic secrets in Terraform</li>
<li>Nomad</li>
<li>TLS certificates</li>
<li>Access tokens</li>
</ul>
<h3 id="terraform">Terraform</h3>
<ul>
<li><strong>Codify infrastructure into declarative files</strong></li>
<li><strong>Blueprint of infrastructure in source repos</strong></li>
<li>Advantages</li>
<li>Resilience</li>
<li>Confidence</li>
<li>Security</li>
</ul>
<h3 id="how-terraform-works">How Terraform Works</h3>
<ul>
<li>Desired state</li>
<li>Actual state</li>
<li>API calls to match actual to desired</li>
</ul>
<h3 id="a-terraform-workflow">A Terraform Workflow</h3>
<p><img alt="Alt Image Text" src="../../images/chap5_3_1.png" title="Body image" /></p>
<h3 id="integration-with-vault">Integration with Vault</h3>
<ul>
<li><strong>Dedicated Terraform Vault provider</strong></li>
<li>
<p><strong>Configuring Vault &amp; populating secrets</strong></p>
</li>
<li>
<p>Can be challenging</p>
</li>
<li>Plaintext secrets in TF code</li>
<li>
<p><strong>Using secrets from Vault</strong></p>
</li>
<li>
<p>Injecting auth data (trusted orchestrator)</p>
</li>
<li>API credentials for “plan” or “apply”</li>
<li>Provided token -&gt; child token -&gt; API creds</li>
<li><strong>Separate read &amp; write with Vault roles</strong></li>
</ul>
<p><a href="https://bit.ly/vault-provider-docs">https://bit.ly/vault-provider-docs</a></p>
<h3 id="demo-creating-the-vault-root-aws-user">Demo: Creating the Vault-Root AWS User</h3>
<p>Let's create a policy that we can attach to the Vault root user.</p>
<p><a href="https://bit.ly/vault-aws-iam-policy">https://bit.ly/vault-aws-iam-policy</a></p>
<pre><code>{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;iam:AttachUserPolicy&quot;,
        &quot;iam:CreateAccessKey&quot;,
        &quot;iam:CreateUser&quot;,
        &quot;iam:DeleteAccessKey&quot;,
        &quot;iam:DeleteUser&quot;,
        &quot;iam:DeleteUserPolicy&quot;,
        &quot;iam:DetachUserPolicy&quot;,
        &quot;iam:GetUser&quot;,
        &quot;iam:ListAccessKeys&quot;,
        &quot;iam:ListAttachedUserPolicies&quot;,
        &quot;iam:ListGroupsForUser&quot;,
        &quot;iam:ListUserPolicies&quot;,
        &quot;iam:PutUserPolicy&quot;,
        &quot;iam:AddUserToGroup&quot;,
        &quot;iam:RemoveUserFromGroup&quot;
      ],
      &quot;Resource&quot;: [&quot;arn:aws:iam::ACCOUNT-ID-WITHOUT-HYPHENS:user/vault-*&quot;]
    }
  ]
}
</code></pre>
<ul>
<li><code>"iam: GetUser"</code></li>
<li><code>"Resource": ["arn: aws: iam: :089854689035 :user/vault-*"]</code></li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap5_3_2.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_3_3.png" title="Body image" /></p>
<pre><code>$ vault secrets enable aws
Success! Enabled the aws secrets engine at: aws/

vault write aws/config/root\
&gt; access_key=AKIARJ26BX4FSFCKYF60
&gt; secret_key=EuQR206F5H0FHsGYpp98WmqPRu0fOzwakL5X1F2z\
&gt; region=ca-central-1
Success! Data written to: aws/config/root
</code></pre>
<p>To rotate the credentials, use</p>
<p><strong><code>vault write ‑force aws/config/rotate‑root</code></strong></p>
<p>and Vault will echo back the new access key ID, but not the associated secret.</p>
<pre><code>terraform vault write -force aws/config/rotate-root
Key                 Value
---                 ----
access_key      AKIARJ26BX4FQZJFWAJ7
</code></pre>
<p><strong><code>terraform-plan</code></strong></p>
<pre><code>vault write aws/roles/terraform-plan \
credential_type=iam_user\
policy_arns=arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess\
policy_document=@iam-getuser-self.json

Success! Data written to: aws/roles/terraform-plan
</code></pre>
<p><strong><code>terraform-apply</code></strong></p>
<pre><code>vault write aws/roles/terraform-apply \
credential_type=iam_user \
policy_arns=arn:aws:iam::aws:policy/AmazonS3FullAccess \
policy_document-@iam-getuser-self.json


Success! Data written to: aws/roles/terraform-apply
</code></pre>
<pre><code>vault write aws/config/lease lease=20m lease max=20m
Success! Data written to: aws/config/lease
</code></pre>
<pre><code>vault policy write terraform-plan./terraform-plan.hcl

Success! Uploaded policy: terraform-plan
</code></pre>
<p><strong><code>terraform-plan.hcl</code></strong></p>
<pre><code>path &quot;aws/creds/terraform-plan&quot; {
    capabilities = [&quot;read&quot;]
}
</code></pre>
<p><strong><code>terraform-apply.hcl</code></strong></p>
<pre><code>path &quot;aws/creds/terraform-apply&quot; {
    capabilities = [&quot;read&quot;]
}
</code></pre>
<pre><code>vault policy write terraform-apply./terraform-apply.hcl
Success! Uploaded policy: terraform-apply
</code></pre>
<p><strong><code>token-creation.hcl</code></strong></p>
<pre><code>path &quot;auth/token/create&quot; {
    capabilities = [&quot;update&quot;]
}
</code></pre>
<pre><code>vault policy write token-creation./token-creation.hcl
Success! Uploaded policy: token-creation
</code></pre>
<pre><code>vault auth enable userpass
Success! Enabled userpass auth method at: userpass/
</code></pre>
<pre><code>vault write auth/userpass/users/plan-user\
password=password \
policies=terraform-plan,token-creation

Success! Data written to: auth/userpass/users/plan-user


vault write auth/userpass/users/apply-user
password=password \
policies=terraform-apply,token-creation

Success! Data written to: auth/userpass/users/apply-user
</code></pre>
<pre><code>VAULT_TOKEN=$(vault login \
-field=token -method=userpass \
username=plan-user password=password) \
vault read aws/creds/terraform-plan


Key             value
---             ---
lease_id        aws/creds/terraform-plan/7jXup8HYnrBasPa@rbire@AI
lease_duration  20m
lease_renewable true
access_key      AKIARJ26BX4F7I7MSCUV 
secret_key        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
security_token  &lt;nils&gt;
</code></pre>
<pre><code>VAULT_TOKEN=$(vault login \
-field=token -method=userpass \
username=plan-user password=password) \
vault read aws/creds/terraform-apply

Error reading aws/creds/terraform-apply: Error making API request.

URL: GET http://127.0.0.1:8200/v1/aws/creds/terraform-apply
Code: 403. Errors:

* 1 error occurred:
    * permission denied
</code></pre>
<ul>
<li><code>username=plan-user</code></li>
<li><code>aws/creds/terraform-apply</code></li>
</ul>
<pre><code>VAULT_TOKEN=$(vault login -field=token -method=userpass username=apply-user password=password) \
TF_VAR_AWS_CREDS_ROLE=terraform-apply 、
terraform apply
random_id.s3_postfix: Refreshing state... [id=0S7p2l21ojOLT0yg3iZ2fA]


VAULT_TOKEN=$(vault login -field=token -method=userpass username=apply-user password=password) \
terraform destroy
</code></pre>
<ul>
<li>Run <code>plan user</code> error</li>
<li><code>TF_VAR_AWS_REDS_ROLE=terraform-plan</code></li>
</ul>
<pre><code>VAULT_TOKEN=$(vault login -field=token -method=userpass username=plan-user password=password) \
TF_VAR_AWS_REDS_ROLE=terraform-plan \
terraform apply
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_3_4.png" title="Body image" /></p>
<ul>
<li><code>username=plan-user</code></li>
<li><code>TF_VAR_AWS_CREDS_ROLE=terraform-apply</code></li>
</ul>
<pre><code>
VAULT_TOKEN=$(vault login -field=token -method=userpass username=plan-user password=password) \
TF_VAR_AWS_CREDS_ROLE=terraform-apply \
terraform apply
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_3_5.png" title="Body image" /></p>
<h2 id="nomad-integration-tokens">Nomad Integration - Tokens</h2>
<p>Nomad is HashiCorp's <strong>workload orchestrator for deploying and managing software across cloud or data center environments at huge scale.</strong></p>
<p>HashiCorps core use cases for <strong>Nomad are container orchestration, legacy application deployment, microservice management</strong> when combined with HashiCorp console, batch processing of analytics workloads, <strong>and building multi‑region or multi‑cloud deployments</strong></p>
<p><strong>Workload orchestrator</strong></p>
<ul>
<li>Deploying &amp; managing software</li>
<li>Cloud or data center at huge scale</li>
</ul>
<p><strong>Core use cases</strong></p>
<ul>
<li>Container orchestration</li>
<li>Legacy application deployment</li>
<li>Microservice management (with Consul)</li>
<li>Batch processing analytics workloads</li>
<li>Multi-region or multi-cloud deployments</li>
</ul>
<h3 id="kubernetes-vs-nomad"><strong>Kubernetes vs Nomad</strong></h3>
<p><strong>Kubernetes</strong></p>
<ul>
<li>Built for containers</li>
<li>Made from interoperating services</li>
<li>Many community-built flavors</li>
<li>Up to 5k nodes &amp; 300k containers</li>
</ul>
<p><strong>Nomad</strong></p>
<ul>
<li>Flexible workloads</li>
<li>Single binary</li>
<li>Consistent experience</li>
<li>10k nodes &amp; 2M containers</li>
</ul>
<h3 id="nomad-acl-system">Nomad ACL System</h3>
<ul>
<li>Built-in Access Control List (ACL) system</li>
<li>Tokens to authenticate requests</li>
<li>Policies define allowed actions</li>
<li>Tokens are secrets &amp; Vault can manage them</li>
<li>Obtain token from Vault, use with Nomad</li>
</ul>
<p><strong><code>config.hcl</code></strong></p>
<pre><code>acl {
  enabled = true
}
</code></pre>
<pre><code>nomad agent -dev -config=config.hcl

===&gt; Loaded configuration from config.hcl
===&gt; Starting Nomad agent...
</code></pre>
<h3 id="nomad-start"><strong>Nomad Start</strong></h3>
<pre><code>$ nomad acl bootstrap

Accessor ID  = aedfa8a-acf0-8b3a-ddde-c1f81342f5da
Secret ID    = Odc11f1e-8cc4-3c62-3fb5-a885668a1bd
Name         = Bootstrap Token
Type         = management
Global       = true
Policies     = n/a
Create Time  = 2021-10-20 20:09:53.713725 +0000 UTC
Create Index = 11
Modify Index = 11
</code></pre>
<pre><code>$ vault secrets enable nomad
Success! Enabled the nomad secrets engine at: nomad/

$ vault write nomad/config/access \
&gt; address=http://localhost: 4646 \
&gt; token=@dc11f1e-8cc4-3c62-3fb5-a88e5668a1bd

Success! Data written to: nomad/config/access

$ vault write nomad/role/management type=management global=true
Success! Data written to: nomad/role/management

$ vault read nomad/creds/management
Key                 Value
---                 ---
lease_id            nomad/creds/management/mnHLOLToCWOhLIXj6qn909rw 
lease_duration      768h
lease_renewable     true
accessor_id         8810099-990-df3b-7a08-cb344ee97029
secret_id           a580d0af-7c11-ff6c-7e5b-303604cd03e7
</code></pre>
<pre><code>nomad-tokensNOMAD_TOKEN=a580d0af-7c11-ff6c-7e5b-303604cd03e7\
&gt; nomad acl token info 8810099-990-df3b-7a08-cb344ee97029
Accessor ID = 8810099-990-df3b-7a08-cb344ee97029
Secret ID   = a580d0af-7c11-ff6c-75b-303604cd03e7
Name        = vault-management-root-1634760866123581000
Type                = management
Global      = true
Policies    = n/a
Create Time = 2021-10-20 20:14:26.12459 +0000 UTC
Create Index = 17
Modify Index = 17
</code></pre>
<p><strong><code>carved-rock-nomad-policy.hcl</code></strong></p>
<pre><code>namespace &quot;carved-rock&quot; {
  policy       = &quot;write&quot;
  capabilities = [&quot;alloc-node-exec&quot;]
}

agent {
  policy = &quot;write&quot;
}

operator {
  policy = &quot;write&quot;
}

quota {
  policy = &quot;write&quot;
}

node {
  policy = &quot;write&quot;
}

host_volume &quot;*&quot; {
  policy = &quot;write&quot;
}
</code></pre>
<pre><code>NOMAD_TOKEN = 0dc11f1e-8cc4-3c62-3fb5-a88e5668a1bd\
&gt; nomad ac policy apply carved-rock carved-rock-nomad-policy.hcl

Successfully wrote &quot;carved-rock&quot; ACL policy!
</code></pre>
<pre><code>vault write nomad/role/carved-rock policies=carved-rock
Success! Data written to: nomad/role/carved-rock

vault read nomad/creds/carved-rock
Key             Value
---             ----
lease_id        nomad/creds/carved-rock/Ureg8XTocZGS144AfZHcBDug
lease_duration  768h
lease_renewable  true
accessor_id      75d0ca50-d8e7-bf51-46ab-4312542d463b
secret_id     87710770-4c15-16b6-2807-8a3b9ead3d87
</code></pre>
<pre><code>NOMAD_TOKEN=87710770-4c15-16b6-2807-8a3b9ead3d87
&gt; nomad acl token info 75d0ca50-d8e7-bf51-46ab-4312542d463b
Accessor ID = 75d0ca50-d87-bf51-46ab-4312542d463b
Secret ID   = 87710770-4c15-16b6-2807-8a3b9ead3d87
Name        = vault-carved-rock-root-1634761248999574000
Type        = client
Global      = false
Policies    = [carved-rock]
Create Time = 2021-10-20 20:20:49.000452 +0000 UTC
Create Index = 27
Modify Index = 27
</code></pre>
<p><a href="https://bit.ly/consul-template-github">https://bit.ly/consul-template-github</a></p>
<h2 id="nomad-integration-mtls">Nomad Integration - mTLS</h2>
<h3 id="nomads-communications">Nomad’s Communications</h3>
<ul>
<li>HTTP between CLI &amp; agents</li>
<li>RPC between agents</li>
<li>Serf between servers specifically</li>
<li>“Agent” could be a client or server</li>
<li>3-5 servers, possibly 1000’s of clients</li>
<li>Serf encrypted through a shared key</li>
<li>HTTP &amp; RPC mutual TLS (mTLS)</li>
<li>Vault can provide certificates</li>
</ul>
<h3 id="nomad-mtls">Nomad mTLS</h3>
<ul>
<li>Both sides verify the other’s identity</li>
<li>Both sides provide certificates</li>
<li>Different to TLS in (HTTPS), not mutual</li>
<li>Prevent unauthorized access</li>
<li>Prevent observing &amp; tampering with comms</li>
<li>Prevent misconfigurations</li>
<li>Prevent masquerading</li>
</ul>
<h3 id="mtls-certificate-rotation">mTLS Certificate Rotation</h3>
<p><strong>Rotate mTLS certificates</strong></p>
<ul>
<li>On every node</li>
<li>Use a short TTL</li>
<li>Time consuming when done manually</li>
</ul>
<p><strong>Consul-template</strong></p>
<ul>
<li>Retrieve secrets &amp; update files</li>
<li>Then run a command</li>
</ul>
<h3 id="demo"><strong>Demo</strong></h3>
<ul>
<li>PKI secrets engine</li>
<li>Consul-template</li>
<li>Automatically create &amp; rotate certificates</li>
</ul>
<h2 id="demo-configuring-vault-consul-template">Demo: Configuring Vault &amp; Consul-template</h2>
<p>How to use <strong>Vault's PKI secrets engine and Consul Template to automatically create and rotate certificates for mTLS in Nomad</strong>.</p>
<p><strong>Setting up the root CA and intermediate CA</strong></p>
<p>It's mounted at <code>pki_int</code> on my Vault server.</p>
<ul>
<li>We'll start by creating a role in the intermediate CA for Nomad to generate certificates.</li>
<li>The <code>max_ttl</code> is set to 24 hours.</li>
<li>We need a Vault policy that will allow access to the issue endpoint for the role.</li>
</ul>
<p><strong><code>nomad-vault-policy.hcl</code></strong></p>
<pre><code>path &quot;pki_int/issue/nomad&quot; {
  capabilities = [&quot;update&quot;]
}
</code></pre>
<pre><code>vault policy write nomad ./nomad-vault-policy.hcl

Success! Uploaded policy: nomad
</code></pre>
<blockquote>
<p>Note that the capability is update and not read.</p>
</blockquote>
<h3 id="consul-template">Consul Template</h3>
<p>We need template files that will expand into an output and a configuration file to provide settings.</p>
<p><strong><code>consul-template-config.hcl</code></strong></p>
<p>The syntax of Consul Template allows you to query for a secret using this with secret string and then providing the path to the secret involved.</p>
<pre><code>vault {
  address      = &quot;http://localhost:8200&quot;

  # You can use the Vault agent to manage the required Vault token
  # vault_agent_token_file = &quot;&quot;

  renew_token=false
}

# Server templates
template {
  source      = &quot;server-templates/ca-certificate.template&quot;
  destination = &quot;server-secrets/ca.crt&quot;
  # command     = &quot;&quot;
}

template {
  source      = &quot;server-templates/certificate.template&quot;
  destination = &quot;server-secrets/server.crt&quot;
  # command     = &quot;&quot;
}

template {
  source      = &quot;server-templates/key.template&quot;
  destination = &quot;server-secrets/server.key&quot;
  # command     = &quot;&quot;
}


# CLI templates
template {
  source      = &quot;cli-templates/certificate.template&quot;
  destination = &quot;cli-secrets/cli.crt&quot;
}

template {
  source      = &quot;cli-templates/key.template&quot;
  destination = &quot;cli-secrets/cli.key&quot;
}
</code></pre>
<p>Every Nomad agent, that is every Nomad server or client, will need a set of three <strong>files to be generated, the issuing CA certificate, its own certificate</strong>, and the associated private key.</p>
<pre><code>├── client-templates
│   ├── ca-certificate.template
│   ├── certificate.template
│   └── key.template
</code></pre>
<p><strong><code>ca-certificate.template</code></strong></p>
<pre><code>{{ with secret &quot;pki_int/issue/nomad&quot; &quot;common_name=server.global.nomad&quot; &quot;ttl=24h&quot;}}
{{ .Data.issuing_ca }}
{{ end }}
</code></pre>
<p><strong><code>certificate.template</code></strong></p>
<pre><code>{{ with secret &quot;pki_int/issue/nomad&quot; &quot;common_name=server.global.nomad&quot; &quot;ttl=24h&quot; &quot;alt_names=localhost&quot; &quot;ip_sans=127.0.0.1&quot;}}
{{ .Data.certificate }}
{{ end }}
</code></pre>
<p><strong><code>key.template</code></strong></p>
<pre><code>{{ with secret &quot;pki_int/issue/nomad&quot; &quot;common_name=server.global.nomad&quot; &quot;ttl=24h&quot; &quot;alt_names=localhost&quot; &quot;ip_sans=127.0.0.1&quot;}}
{{ .Data.private_key }}
{{ end }}
</code></pre>
<p><strong>On clients, the common name is <code>client.global.nomad</code>, and on servers, it is <code>server.global.nomad</code>. </strong></p>
<p>Notice as well that all of these templates are asking for their secrets with a TTL of 24 hours. Y</p>
<p>HashiCorp suggests adding these to every node in your cluster so that you can use the CLI anywhere within it.</p>
<pre><code>cli-templates
│   ├── certificate.template
│   └── key.template
</code></pre>
<p><strong><code>certificate.template</code></strong></p>
<pre><code>{{ with secret &quot;pki_int/issue/nomad&quot; &quot;ttl=24h&quot; }}
{{ .Data.certificate }}
{{ end }}
</code></pre>
<p><strong><code>key.template</code></strong></p>
<pre><code>{{ with secret &quot;pki_int/issue/nomad&quot; &quot;ttl=24h&quot; }}
{{ .Data.private_key }}
{{ end }}
</code></pre>
<pre><code>vault write pki int/roles/nomad allowed_domains=global.nomad \
allow_subdomains=true max_ttl=86400s require_cn=false generate_lease=true

Success! Data written to: pki_int/roles/nomad
</code></pre>
<pre><code>consul-template-config=consul-template-config.hcl
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_3_6.png" title="Body image" /></p>
<h2 id="demo-configuring-nomad-for-mtls">Demo: Configuring Nomad for mTLS</h2>
<p><strong>Configure nomad to use mTLS</strong></p>
<p><strong><code>nomad-config.hcl</code></strong></p>
<pre><code>tls {
  http = true
  rpc  = true

  ca_file   = &quot;server-secrets/ca.crt&quot;
  cert_file = &quot;server-secrets/server.crt&quot;
  key_file  = &quot;server-secrets/server.key&quot;

  verify_server_hostname = true
  verify_https_client    = true
}
</code></pre>
<pre><code>nomad agent -dev -config=nomad-config.hcl
=&gt; Loaded configuration from nomad-config.hcl
=&gt; Starting Nomad agent.
</code></pre>
<pre><code>$ nomad status
Error querying jobs: Unexpected response code: 400 (Client sent an HTTP request to an HTTPS servr.
</code></pre>
<blockquote>
<p>we receive an error because the default nomad address for the CLI uses HTTP, and we've just configured the endpoint to use HTTPS</p>
</blockquote>
<p>To make the CLI work, we need to export four environment variables.</p>
<pre><code>export NOMAD_ADDR=https://localhost:4646
export NOMAD CACERT=server-secrets/ca.crt
export NOMAD CLIENT CERT=cli-secrets/cli.crt
export NOMAD CLIENT KEY=cli-secrets/cli.key
</code></pre>
<pre><code>nomad status
No running jobs
</code></pre>
<pre><code>openssl s_client -cert $NOMAD_CLIENT_CERT -key $NOMAD_CLIENT_KEY \
-connect localhost: 4646 2&gt; /dev/null I
openssl x509 -noout -dates
notBefore=Oct 20 21:20:05 2021 GMT
notAfter=Oct 21 21:20:35 2021 GMT
</code></pre>
<p><strong>It connects to the Nomad endpoint using the CLI certificate and key, then grabs the certificate from the Nomad server and passes out the dates that the certificate is valid from and to.</strong></p>
<p>You can see here that the notBefore and not After date times make up a 24‑hour period</p>
<h2 id="module-review">Module Review</h2>
<p><strong>Terraform</strong></p>
<ul>
<li>AWS secrets engine</li>
<li>Differing levels of access for TF</li>
</ul>
<p><strong>Nomad</strong></p>
<ul>
<li>Produce tokens</li>
<li>PKI engine</li>
<li>Consul-template</li>
<li>mTLS</li>
<li>Automatic certificate rotation</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>