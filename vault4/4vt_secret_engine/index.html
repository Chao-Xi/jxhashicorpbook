
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault4/4vt_secret_engine/">
      
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>**L4 Managing Secrets with Secrets Engines** - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l4-managing-secrets-with-secrets-engines" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              **L4 Managing Secrets with Secrets Engines**
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/3vault_rotate/" class="md-nav__link">
        L3 透过 Vault 定期 rotate credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault1/4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/4encryption_key/" class="md-nav__link">
        L4 Managing Encryption and Seal Keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/8vaba_monitor/" class="md-nav__link">
        L8 Configuring Auditing and Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/3vault_tf_nd/" class="md-nav__link">
        L3 Integrating Vault with Terraform & Nomad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/1encrypt_key/" class="md-nav__link">
        L1 Managing the Encryption Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-the-database-secrets-engine" class="md-nav__link">
    Using the Database Secrets Engine
  </a>
  
    <nav class="md-nav" aria-label="Using the Database Secrets Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vault-database-secrets-engines" class="md-nav__link">
    Vault Database Secrets Engines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distribute-username-password-secrets" class="md-nav__link">
    Distribute Username / Password Secrets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-vault-to-generate-dynamic-credentials" class="md-nav__link">
    Using Vault to Generate Dynamic Credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mysql" class="md-nav__link">
    install MySQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-vailt-database" class="md-nav__link">
    Enable vailt database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reader-role-with-read-policy" class="md-nav__link">
    Reader role with read policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writer-role-with-write-policy" class="md-nav__link">
    Writer role with write policy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-the-ssh-secrets-engine" class="md-nav__link">
    Working with the SSH Secrets Engine
  </a>
  
    <nav class="md-nav" aria-label="Working with the SSH Secrets Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-would-end-users-request-otps" class="md-nav__link">
    Why would end-users request OTPs?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vault-otp-dynamics" class="md-nav__link">
    Vault OTP Dynamics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-secrets-engine" class="md-nav__link">
    SSH Secrets Engine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-would-end-users-request-otps_1" class="md-nav__link">
    Why would end-users request OTPs?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-ssh-integrate-with-vault" class="md-nav__link">
    Enable SSH integrate with Vault
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-vault-ssh-secret" class="md-nav__link">
    Enable vault-ssh secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-ubuntu" class="md-nav__link">
    ON UBUNTU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-the-aws-secret-engine" class="md-nav__link">
    Working with the AWS Secret Engine
  </a>
  
    <nav class="md-nav" aria-label="Working with the AWS Secret Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo_1" class="md-nav__link">
    Demo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certificate-revocation-lists-crls" class="md-nav__link">
    Certificate Revocation Lists (CRLs)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configrue-lambda-trigger" class="md-nav__link">
    Configrue Lambda trigger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-api-standards" class="md-nav__link">
    AWS API Standards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-leases-from-dynamic-secrets" class="md-nav__link">
    Managing Leases from Dynamic Secrets
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l4-managing-secrets-with-secrets-engines"><strong>L4 Managing Secrets with Secrets Engines</strong></h1>
<ul>
<li>Database secrets engine at Globomantics</li>
<li>SSH secrets engine - manage SSH servers</li>
<li>PKI secrets engine - run your own Certificate Authority</li>
</ul>
<h2 id="using-the-database-secrets-engine"><strong>Using the Database Secrets Engine</strong></h2>
<p><img alt="Alt Image Text" src="../../images/vt5_1_1.png" title="Body image" /></p>
<h3 id="vault-database-secrets-engines">Vault Database Secrets Engines</h3>
<ul>
<li>Don’t store secrets in relational databases </li>
<li>Function as simple authentication mechanisms</li>
</ul>
<h3 id="distribute-username-password-secrets"><strong>Distribute Username / Password Secrets</strong></h3>
<p><img alt="Alt Image Text" src="../../images/vt5_1_2.png" title="Body image" /></p>
<h3 id="using-vault-to-generate-dynamic-credentials">Using Vault to Generate Dynamic Credentials</h3>
<p><img alt="Alt Image Text" src="../../images/vt5_1_3.png" title="Body image" /></p>
<h3 id="best-practices">Best Practices</h3>
<ul>
<li>Dynamic secrets </li>
<li>Leases to control secrets lifecycle</li>
</ul>
<h3 id="demo"><strong>Demo</strong></h3>
<p>Using the Database Secrets Engine</p>
<ul>
<li>Enable DB secrets engine </li>
<li>Configure its database connection </li>
<li>Set roles in the database secrets engine </li>
<li>Create related policies in Vault </li>
<li>Generate tokens </li>
<li>Use tokens to log into the database</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/vt5_1_4.png" title="Body image" /></p>
<pre><code>$ vault server -dev
...
You may need to set the following environment variables:

    $ export VAULT_ADDR='http://127.0.0.1:8200'

The unseal key and root token are displayed below in case you want to
seal/unseal the Vault or re-authenticate.

Unseal Key: H65WnFroE99hEp17qQ/qYG8+T1TF/6seryMoG6q52PI=
Root Token: hvs.mkzvtZeivMkg6SSpdA3Wfk1m
...



$ vault operator unseal H65WnFroE99hEp17qQ/qYG8+T1TF/6seryMoG6q52PI=
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.12.2
Build Date      2022-11-23T12:53:46Z
Storage Type    inmem
Cluster Name    vault-cluster-f56d0349
Cluster ID      4694a9ba-acf0-89b2-98f3-90657f4d52af
HA Enabled      false
</code></pre>
<h3 id="install-mysql">install MySQL</h3>
<pre><code># Install MySQL
brew install mysql

# Start the database - runs as a daemon
brew services start mysql

# To start it on the foreground
mysql.server start
mysql.server stop


# Secure the database - by default there is not root password
mysql_secure_installation
# Press y|Y for Yes, any other key for No: Type N, as this database is just for testing purposes, and thus you don't need to test password strength
# Remove anonymous users? (Press y|Y for Yes, any other key for No) : again type N
# Disallow root login remotely? (Press y|Y for Yes, any other key for No) : type N
# Remove test database and access to it? (Press y|Y for Yes, any other key for No) : type N
# Reload privilege tables now? (Press y|Y for Yes, any other key for No) : type Y
# Success.
# All done!

# Test the installation
mysql -u root -p   
</code></pre>
<h3 id="enable-vailt-database">Enable vailt database</h3>
<pre><code># Enable the database secrets engine
vault secrets enable database

$ vault secrets enable database
Success! Enabled the database secrets engine at: database/


# Configure the db engine
vault write database/config/mysql \
    plugin_name=mysql-database-plugin \
    connection_url=&quot;{{username}}:{{password}}@tcp(localhost:3306)/&quot; \
    allowed_roles=&quot;reader,writer&quot; \
    username=&quot;root&quot; \
    password=&quot;sup3rm1sqlp@ss0rd&quot;


# Create reader role
vault write database/roles/reader \
    db_name=mysql \
    creation_statements=&quot;CREATE USER '{{name}}'@'%' IDENTIFIED BY '{{password}}'; GRANT SELECT ON *.* TO '{{name}}'@'%';&quot; \
    default_ttl=&quot;2h&quot; \
    max_ttl=&quot;48h&quot;


# Create writer role
vault write database/roles/writer \
    db_name=mysql \
    creation_statements=&quot;CREATE USER '{{name}}'@'%' IDENTIFIED BY '{{password}}'; GRANT ALL ON *.* TO '{{name}}'@'%';&quot; \
    default_ttl=&quot;2h&quot; \
    max_ttl=&quot;48h&quot; 
</code></pre>
<ul>
<li><strong><code>reader.hcl</code></strong></li>
</ul>
<pre><code># Allow the reader role access to the path that generates the credentials
path &quot;database/creds/reader&quot; {
    policy = &quot;read&quot;
}
</code></pre>
<ul>
<li><strong><code>writer.hcl</code></strong></li>
</ul>
<pre><code># Allow the writer role access to the path that generates the credentials
path &quot;database/creds/writer&quot; {
    policy = &quot;read&quot;
}
</code></pre>
<pre><code># Upload the policies
vault policy write reader reader.hcl
Success! Uploaded policy: reader


vault policy write writer writer.hcl
Success! Uploaded policy: writer
</code></pre>
<h3 id="reader-role-with-read-policy">Reader role with read policy</h3>
<pre><code># Create tokens, log in, and create credentials with the reader role
$ vault token create -policy=reader

$ vault token create -policy=reader

Key       Value
token    S.CMFwtkvmgubnhzLVLgBARAP9
token_accessor  deELtZVqUfXrEjmMYFBLWy6M
token_duration  768h
token_renewable true
token_policies  [“default&quot; “reader”]
identity_policies   []
policies        [&quot;default”“reader”]
</code></pre>
<pre><code># Create tokens, log in, and create credentials with the reader role
vault token create -policy=reader

$ vault login s.CMFWtkvmgubnhzlVLgBARAP9

$ vault read database/creds/reader
Key   Value
Lease_id    database/creds/reader/va4tpxgvbgSiQqkoE476BX2
Lease_duration  2h
Lease_renewable true
password    nJsaAAZtO-CLOpjIUwZV
username    V-token-reader-20mJBKAAIg4AKWKOy
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_5.png" title="Body image" /></p>
<pre><code>mysql -uv-token-reader-20mJBKAAIg4AKwKOy -pnJsaAAZto-CL0pjIUwzV -h localhost

mysql&gt; show databases;
+-------—---------—--+
| Database           |
+-------—---------—--+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+-------—---------—--+
4 rows in set (0.00 sec)

mysql» use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

mysql» create database globomanticsdb;
ERROR 1044 (42000): Access denied for user 'v-token-reader-20mJBKAAIg4AKwKOy'a'%' to database 'globomanticsdb
</code></pre>
<h3 id="writer-role-with-write-policy">Writer role with write policy</h3>
<pre><code># as root
$ vault login hvs.mkzvtZeivMkg6SSpdA3Wfk1m
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.mkzvtZeivMkg6SSpdA3Wfk1m
token_accessor       sL3wVBYzguqLCVVuaDPjl0ur
token_duration       ∞
token_renewable      false
token_policies       [&quot;root&quot;]
identity_policies    []
policies             [&quot;root&quot;]

$ vault token create -policy=writer

Key             Value
token           s.9i1yhhTocogoR7WULCVQ02
token_accessor  KVvQYY9tX6bd4QkYL4dvtp
token_duration  768h
token_renewable true
token_poicies   [“default”&quot;writer&quot;]
identity_policies []
policies    [“default&quot; &quot;writer]
</code></pre>
<pre><code>vault login s.9i1yhhTocogoR7WULCVQ02

vault read database/creds/writer
Key Value
Lease_id    database/creds/writer/Ic10U9KzL5ECCNmN4gDILjjL
Lease_duration  2h
Lease_renewable true
password    nRG7iHGRC6-dVhru5uvh
username    v-token-writer-x43SOMOPjCEL6Zvkb
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_6.png" title="Body image" /></p>
<p>Success; the writer role and its corresponding user have create (ALL) privileges</p>
<pre><code># Now log in to the database with the generated credentials
mysql -uv-token-writer-x43s0MOPjCEl6zvkb -pnRG7iHGRC6-dVhrU5uVh -h localhost

mysql» create database globomanticsdb;
Query OK, 1 row affected (0.04 sec)

mysql&gt; create database globomanticsdb; 

mysql&gt; show databases;
+-------—---------—--+
| Database           |
+-------—---------—--+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+-------—---------—--+
4 rows in set (0.00 sec)

show databases;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_7.png" title="Body image" /></p>
<h2 id="working-with-the-ssh-secrets-engine">Working with the SSH Secrets Engine</h2>
<h3 id="why-would-end-users-request-otps">Why would end-users request OTPs?</h3>
<ul>
<li>Mission-critical access</li>
<li>Minimal amount of time for credentials validity</li>
</ul>
<h3 id="vault-otp-dynamics">Vault OTP Dynamics</h3>
<p><img alt="Alt Image Text" src="../../images/vt5_1_8.png" title="Body image" /></p>
<ol>
<li>Enable ssh secrets engine</li>
<li>Create a role to connect to SSH servers</li>
<li><strong>Install Vault SSH Helper</strong></li>
<li><strong>Reconfigure SSHD to use helper</strong></li>
<li><strong>Test Helper to Vault link</strong></li>
<li>Generate OT dynamically</li>
<li>Present OTP to SSH Server</li>
<li>Validate OTP</li>
<li>Authenticate and revoke OTP</li>
</ol>
<h3 id="ssh-secrets-engine"><strong>SSH Secrets Engine</strong></h3>
<p><strong>The Vault SSH secrets engine provides secure authentication and authorization for access to machines via the SSH protocol</strong>. </p>
<p>The Vault SSH secrets engine helps manage access to machine infrastructure, providing several ways to issue
SSH credentials.</p>
<p>The Vault SSH secrets engine supports the following modes. Each mode is individually documented on its own page</p>
<ul>
<li>Signed SSH Certificates</li>
<li>One-time SSH Passwords</li>
<li>Dynamic SSH Keys (DEPRECATED)</li>
</ul>
<p>Vault can create a one-time password (OTP) for SSH authentication on a network every time a client wants to SSH into a remote host using a helper command on the remote host to perform verification.</p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_9.png" title="Body image" /></p>
<h3 id="why-would-end-users-request-otps_1">Why would end-users request OTPs?</h3>
<ul>
<li>Mission-critical access</li>
<li>Minimal amount of time for credentials validity</li>
</ul>
<h3 id="enable-ssh-integrate-with-vault">Enable SSH integrate with Vault</h3>
<pre><code>#!/bin/bash

# The instructions below were tested on Ubuntu 20.04
wget https://releases.hashicorp.com/vault-ssh-helper/0.2.1/vault-ssh-helper_0.2.1_linux_386.zip
unzip vault-ssh-helper_0.2.1_linux_386.zip
mv vault-ssh-helper /usr/local/bin
export VAULT_ADDR=http://localhost:8200/
rm vault-ssh-helper_0.2.1_linux_386.zip
</code></pre>
<h3 id="enable-vault-ssh-secret">Enable vault-ssh secret</h3>
<pre><code>$ vault secrets enable ssh
Success! Enabled the ssh secrets engine at: ssh/
</code></pre>
<h3 id="on-ubuntu">ON UBUNTU</h3>
<pre><code># .bashrc
export VAULT_ADDR=http://localhost:8200
</code></pre>
<ul>
<li><strong><code>install_vault_ssh_helper.sh</code></strong></li>
</ul>
<pre><code># Allow you terminal (or your IDE, like VS Code, if you prefer) full disk access - see the screenshot: enable_full_disk_access_on_mac.png

# Enable/disable SSHD on Mac by executing
sudo systemsetup -setremotelogin on

# Execute install_vault_ssh_helper.sh as root
sudo -s
chmod +x install_vault_ssh_helper.sh 

./install_vault_ssh_helper.sh 
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_10.png" title="Body image" /></p>
<pre><code>#ls -l /usr/local/bin/

-rwxr-xr-x1 root root 8383402 Dec 15 2020 vault-ssh-helper
</code></pre>
<pre><code># Install SSHD
apt-get update &amp;&amp; apt-get install -y openssh-server

# Modify SSH Config
auth requisite pam_exec.so quiet expose_authtok log=/tmp/vaultsshhelper.log /usr/local/bin/vault-ssh-helper -dev -config=/etc/vault-ssh-helper.d/config.hcl
auth optional pam_unix.so not_set_pass use_first_pass nodelay
</code></pre>
<p><strong><code>config.hcl</code></strong></p>
<pre><code>vault_addr = &quot;http://localhost:8200&quot;
tls_skip_verify = true
# ca_cert = &quot;&lt;PEM_ENCODED_CA_CERT&gt;&quot;
ssh_mount_point = &quot;ssh&quot;
# namespace = &quot;my_namespace&quot;
allowed_roles = &quot;*&quot;
</code></pre>
<pre><code>systemctl restart ssh.service

systemctl status ssh.service
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_11.png" title="Body image" /></p>
<pre><code># Create user that will connect to Vault server
adduser vsshuser

# Create vaultadmin role; vsshuser is the username we will specify when connecting to the ssh server
# cidr_list=0.0.0.0/0,0.0.0.0/0 - this range specifies we can connect from anywhere to the ssh server
vault write ssh/roles/vaultadmin \
    key_type=otp \
    default_user=vsshuser cidr_list=0.0.0.0/0,0.0.0.0/0
</code></pre>
<pre><code>cd ../conf/
# Create config director for the Vault SSH Helper and place the its config file in it
sudo mkdir /etc/vault-ssh-helper.d/
sudo cp -p vault-ssh-helper.hcl

# Test Vault SSH Helper
$ vault-ssh-helper -dev -verify-only -config=/etc/vault-ssh-helper.d/config.hcl
2021/09/15 12:49:11 ==&gt; WARNING: Dev mode is enabled!
2021/09/15 12:49:11 (INFO] using SSH mount point: ssh
2021/09/15 12:49:11 (INF0] using namespace:
2021/09/15 12:49:11 (INFO] vault-ssh-helper verification successful!
</code></pre>
<pre><code>$ ifconfig
inet 10.0.2.15| netmask 255.255.255.0 broadcast 10.0.2.255
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_12.png" title="Body image" /></p>
<pre><code># Generate one-time password (OTP)
vault write ssh/creds/vaultadmin ip=10.0.2.15

Key                     Value
lease_id            ssh/creds/vaultadmin/dU1IHrGwtdaUP17p8LzNMOID
lease_duration    768h
lease_renewable false
ip              10.0.2.15
key         05dbd824-b832-5454-ac87-7b88f2bc6abf
key_type    otp
port            22
username    vsshuser
</code></pre>
<pre><code>ssh vsshuser@127.0.0.1 -p 2222

root@jaguargs:/home/gsmith/vault/conf#cat/tmp/vaultsshhelper.log
wed Sep 15 15:12:23 Z0ZT
2021/09/15 15:12:23 ==&gt; WARNING: Dev mode is enabled!
2021/09/15 15:12:23 (INFO] using SSH mount point: ssh
2021/09/15 15:12:23 (INFO] using namespace:
2021/09/15 15:12:23 [INFO] vsshuser@10.0.2.15 authenticated!
root@jaguargs:/home/gsmith/vault/conf#ls-l/tmp/vaultsshhelper.log
-rw-r..r.- 1 root root 243 Sep 15 15:12 /tmp/vaultsshhelper.log
root@jaguargs:/home/gsmith/vault/conf# usermod -aG sudo username
usermod: user
&quot;username' does not exist

# usermod -aG sudo vsshuser

# su - vsshuser
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;
See &quot;man sudo root&quot; for details.

$ sudo ls -la /root

$ exit
logout
</code></pre>
<pre><code>ssh vsshuser@127.0.0.1 -p 2222
vsshuser@127.0.0.1's password:
Permission denied, please try again.
vsshuser@127.0.0.1's password:
Permission denied, please try again.
vsshuser@127.0.0.1's password:
</code></pre>
<p><strong>Create new one with sudo permisssion</strong></p>
<pre><code>vault write ssh/creds/vaultadminip=10.0.2.15

# After you connect successfully, log out, and try connecting again using the same passowrd
# That will fail because you alerady used the password once
# Enable port forwarding in VirtualBox - VM &gt; Settings &gt; Network  &gt; Port Forwarding - open port 22 on 127.0.1.1 
# and that will forward traffic to port 22 of 10.0.2.15 - internal address of your VM
# OTP: 05dbd824-b832-5454-ac87-7b88f2bc6abf
ssh vsshuser@localhost -p 2222



cat /tmp/vaultsshhelper. log
*** Fri Sep 17 01:03:36 2021
2021/09/17 01:03:36 ==&gt; WARNING: Dev mode is enabled!
2021/09/17 01:03:36 (INFO] using SSH mount point: ssh
2021/09/17 01:03:36 (INFO] using namespace:
2021/09/17 01:03:36 [INFO] vsshuser@10.0.2.15 authenticated!
*** Fri Sep 17 01:22:00 2021
2021/09/17 01:22:00 ==&gt; WARNING: Dev mode is enabled!
2021/09/17 01:22:00 [INFO] using SSH mount point: ssh
2021/09/17 01:22:00 [INFO] using namespace:
2021/09/17 01:22:00 [ERROR]: Error making API request.
URL: PUT http: //10.0.2.2:8200/vl/ssh/verify
Code: 400. Errors:
* OTP not found
*** Fri Sep 17 01:22:03 2021
2021/09/17 01:22:03 ==&gt; WARNING: Dev mode is enabled!
2021/09/17 01:22:03 (INFO] using SSH mount point: ssh
2021/09/17 01:22:03 (INFO] using namespace:
2021/09/17 01:22:03 [ERROR]: Error making API request.
URL: PUT http://10.0.2.2:8200/v1/ssh/verify
Code: 400. Errors:
* OTP not found
*** Fri Sep 17 01:24:40 2021
2021/09/17 01:24:40 ==&gt; WARNING: Dev mode is enabled!
2021/09/17 01:24:40 [INFO] using SSH mount point: ssh
2021/09/17 01:24:40 (INFO] using namespace:
2021/09/17 01:24:40 (INFO] vsshuser@10.0.2.15 authenticated!

</code></pre>
<h2 id="working-with-the-aws-secret-engine">Working with the AWS Secret Engine</h2>
<p>First, we'll create a Lambda function on AWS and expose it via the AWS API Gateway. </p>
<p>Then we'll configure Vault to access our AWS account as root. </p>
<p>Create a role for our Vault users and map it to an AWS IAM policy, which is nothing more than a set of permissions allowing them to take specific actions like accessing and modifying resources.</p>
<h3 id="demo_1">Demo</h3>
<p>Using the Database Secrets Engine</p>
<ul>
<li>Generate Root and Intermediate CAs </li>
<li>Create a role that allows for managing subdomains </li>
<li>Request and generate certificates </li>
<li>Revoke and remove certificates</li>
</ul>
<h3 id="certificate-revocation-lists-crls">Certificate Revocation Lists (CRLs)</h3>
<ul>
<li>Generate Credentials  as dynamic secrets</li>
<li>Verify certificate is NOT on CRLs</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/vt5_1_13.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_14.png" title="Body image" /></p>
<p><strong>AWS Root Keys</strong></p>
<ul>
<li>Don't share them with anyone</li>
<li>Vault uses them to create new secrets</li>
</ul>
<h3 id="configrue-lambda-trigger">Configrue Lambda trigger</h3>
<p><strong>Trigger configuration</strong></p>
<ul>
<li>Create an API</li>
<li>REST API</li>
<li>IAM</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/vt5_1_15.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_16.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_17.png" title="Body image" /></p>
<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;AWS&quot;: &quot;*&quot;
            },
            &quot;Action&quot;: &quot;execute-api:Invoke&quot;,
            &quot;Resource&quot;: &quot;arn:aws:execute-api:us-east-2:239136941756:*/*/*/*&quot;
        }
    ]
}
</code></pre>
<pre><code># Enable AWS secrets engine
vault secrets enable aws

# Configure Vaut’s root access
vault write aws/config/root \
    access_key=A*6 \
    secret_key=n*D \
    region=us-east-2
</code></pre>
<h3 id="aws-api-standards">AWS API Standards</h3>
<pre><code># Create role in Vault and link it to an AWS policy
# this role will allow users/apps to call the Lambda function via the API gateway
vault write aws/roles/dev-role \
    credential_type=iam_user \
    default_ttl=5m
    policy_document=-&lt;&lt;EOF
{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;DevRoleInlinePolicy1&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;apigateway:*&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
EOF
</code></pre>
<pre><code>vault read aws/creds/dev-role
Key                Value
---                -----
lease_id           aws/creds/dev-role/PHsJqJuWMfDMP0gBoYfZLDqV
lease_duration     768h
lease_renewable    true
access_key         AKIATPLNME26DOZTWH7S
secret_key         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
security_token     &lt;nil&gt;
</code></pre>
<p><strong>Vault generated IAM user</strong></p>
<pre><code>vault-token-dev-role-1632044346-8561
</code></pre>
<p><img alt="Alt Image Text" src="../../images/vt5_1_19.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_20.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/vt5_1_18.png" title="Body image" /></p>
<h3 id="managing-leases-from-dynamic-secrets"><strong>Managing Leases from Dynamic Secrets</strong></h3>
<p>All dynamic secrets in Vault come with a lease. </p>
<p>And so, there are three main cases surrounding the lease and how it <strong>governs a secrets lifecycle. Secrets expire, are renewed, or can be revoked</strong></p>
<ul>
<li><strong>Control lease expiration</strong></li>
</ul>
<pre><code>vault secrets tune -default-lease-ttl=5m aws/
vault secrets tune -default-lease-ttl=5m -max-lease-ttl=20m aws/
</code></pre>
<ul>
<li><strong>Renew lease</strong> </li>
</ul>
<pre><code># Renew lease for 600 sec, or 10 min - within max_lease_ttl of 20 min - see above
vault lease renew -increment=600 my-lease-id
vault lease lookup aws/creds/dev-role/fZWeCwRT8l9xbRxrDoEpDRTe
</code></pre>
<ul>
<li><strong>Revoke credentials</strong></li>
</ul>
<pre><code># Revoke credentials
vault lease revoke aws/creds/dev-role/CdTx14Wl0m1kyUI6luKlEEsl
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>