
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Hashicorp Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxhashicorpbook/vault1/3vault_rotate/">
      
      
        <link rel="prev" href="../2vault_k8s/">
      
      
        <link rel="next" href="../4vault_int_k8s/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>L3 透过 Vault 定期 rotate credentials - Jacob Hashicorp Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-greay">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#l3-vault-rotate-credentials" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Hashicorp Book" class="md-header__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Hashicorp Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              L3 透过 Vault 定期 rotate credentials
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Hashicorp Book" class="md-nav__button md-logo" aria-label="Jacob Hashicorp Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Hashicorp Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxhashicorpbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxhashicorpbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          私密信息管理利器Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          私密信息管理利器Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/1vault_intro/" class="md-nav__link">
        1 私密信息管理利器 HashiCorp Vault——简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/2vault_start/" class="md-nav__link">
        2 私密信息管理利器 HashiCorp Vault——启动和读写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/3vault_secretengine/" class="md-nav__link">
        3 私密信息管理利器 HashiCorp Vault——Secret Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/4vault_auth/" class="md-nav__link">
        4 私密信息管理利器 HashiCorp Vault——验证和授权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/5vault_deploy/" class="md-nav__link">
        5 私密信息管理利器 HashiCorp Vault——部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/6vault_api/" class="md-nav__link">
        6 私密信息管理利器 HashiCorp Vault——REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/7vault_impl/" class="md-nav__link">
        7 密钥管理神器之 Vault 集群搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/8vault_k8s/" class="md-nav__link">
        8 K8S与Vault集成，进行Secret管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/9vault_docker/" class="md-nav__link">
        9 使用 Docker 和 Traefik 搭建 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/10vault_cm/" class="md-nav__link">
        10 使用 Vault + Cert Manager 管理 Kubernetes 集群中的数字证书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/13vault_ack_cloud/" class="md-nav__link">
        11 云原生更安全的密文管理 Vault on ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault/14K8s_secret/" class="md-nav__link">
        12 Kubernetes 的 secret 并不是真正的 secret
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Vault on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Vault on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0k8s_vault/" class="md-nav__link">
        L0 在 Kubernetes 上部署 Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1Vault_basic/" class="md-nav__link">
        L1 Hashcorp Vault 基础使用教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2vault_k8s/" class="md-nav__link">
        L2 在 Kubernetes 读取 Vault 中的机密信息
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          L3 透过 Vault 定期 rotate credentials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        L3 透过 Vault 定期 rotate credentials
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vault" class="md-nav__link">
    Vault 介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    范例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    设定环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    踩雷区
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4vault_int_k8s/" class="md-nav__link">
        L4 Vault 与 Kubernetes 的深度整合
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Hashicorp Certified Vault Associate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Hashicorp Certified Vault Associate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/1vaba_intro/" class="md-nav__link">
        L1 Vault Associate: Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/2vaba_auth_poly/" class="md-nav__link">
        L2 Authentication and Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/3vaba_token/" class="md-nav__link">
        L3 Vault Token
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/4vaba_engines/" class="md-nav__link">
        L4 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault2/5vaba_lease/" class="md-nav__link">
        L5 Using Vault Leases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Installing Configuring Vault
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Installing Configuring Vault
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/1intro/" class="md-nav__link">
        L1 HashiCorp Vault Overview and Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/2dev_model/" class="md-nav__link">
        L2 Vault a Deployment Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/3deploy_valut/" class="md-nav__link">
        L3 Deploying Vault Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/4encryption_key/" class="md-nav__link">
        L4 Managing Encryption and Seal Keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/5conf_ha/" class="md-nav__link">
        L5 Configuring High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/6basic_auth/" class="md-nav__link">
        L6 Configuring Basic Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/7vaba_secret_engine/" class="md-nav__link">
        L7 Using Secrets Engines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault3/8vaba_monitor/" class="md-nav__link">
        L8 Configuring Auditing and Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Managing Access and Secrets(Adv.)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Managing Access and Secrets(Adv.)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/1mag_vt_intro/" class="md-nav__link">
        L1 Secrets in HashiCorp Vault Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/2vt_auth_method/" class="md-nav__link">
        L2 Installing and Configuring Authentication Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L3 Working with Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault4/3vt_token/" class="md-nav__link">
        L4 Managing Secrets with Secrets Engines
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Integrating with DevOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Integrating with DevOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/1cicd_pipeline/" class="md-nav__link">
        L1 Accessing Secrets in CI/CD Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/2vault_agent/" class="md-nav__link">
        L2 Securely Introducing Clients Using Vault Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/3vault_tf_nd/" class="md-nav__link">
        L3 Integrating Vault with Terraform & Nomad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/4vault_consul/" class="md-nav__link">
        L4 Integrating Vault with Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/5vault_cloud/" class="md-nav__link">
        L5 Authenticating Using Cloud Machine Identity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault5/6vault_k8s/" class="md-nav__link">
        L6 Integrating Vault with Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Ops on Vault Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Ops on Vault Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/1encrypt_key/" class="md-nav__link">
        L1 Managing the Encryption Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/2bak_storage/" class="md-nav__link">
        L2 Managing the Storage Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/3incident/" class="md-nav__link">
        L3 Managing the Vault Server during an Incident
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vault6/4Plugins/" class="md-nav__link">
        L4 Managing External Plugins and Server Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Terraform Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Terraform Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/1Terragrunt/" class="md-nav__link">
        L1 使用Terragrunt优化Terraform代码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tfm1/2TMF_JENKINS/" class="md-nav__link">
        L2 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vault" class="md-nav__link">
    Vault 介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    范例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    设定环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    踩雷区
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="l3-vault-rotate-credentials"><strong>L3 透过 Vault 定期 rotate credentials</strong></h1>
<p>建立一个软件服务时，刚开始通常都会把 <code>API Key</code>、连接资料库或 <code>AWS</code> 的帐号密码储存在各式各样的地方，档案、环境变数、甚至一个不小心就储存到 <code>git</code> 裡面。</p>
<p><img alt="Alt Image Text" src="../../images/2_1.png" title="Body image" /></p>
<p>随意储存固然方便简单，但是伴随安全隐忧。随着服务愈来愈重要，开发者会开始更加安全的储存这些重要的资讯，例如将这些 <code>credential</code> 集中储存在同一个地方。除此之外通常也会从多个面向来提昇安全性，像是缩限每个 <code>credential</code> 的存取范围，或是过一段时间就更换一次 <code>credential</code> 等等。</p>
<p>可是要定期更换 <code>credential</code> 是一件多么痛苦的事情，假如说服务中有十个 <code>instance</code> ，要规划安全又不中断服务的方式更换所有 <code>instance</code> 的资料库帐号密码会是个很大的挑战。</p>
<p>当使用的 <code>credential</code> 数量与种类增加，痛苦指数就会快速上升。</p>
<p><strong>今天想来介绍 <code>Vault</code>，用它来动态的产生 <code>credential</code> 可以痛苦指数降低一些。</strong></p>
<h2 id="vault">Vault 介绍</h2>
<p>https://www.vaultproject.io/</p>
<p><code>Vault</code> 是一套由 <code>HashiCorp</code> 主导开发用于管理机密资料的开源专案。所有储存在 <code>vault</code> 内的资料都会经过加密，管理者可以透过开设不同的帐号或 <code>token</code> 来限制不同的存取范围，同时 <code>token</code> 的存取纪录都会透过 <code>audit</code> 模组记录下来，方便之后查核用途。</p>
<p>但是安全的存放机密资料并不是 <code>vault</code> 最实用的地方，<code>Vault</code> 方便之处在于它可以帮你动态的产生 <code>credential</code> 并且设定过期的期限，等期限到了 <code>Vault</code> 会帮你撤销该 <code>credential</code>。</p>
<p><img alt="Alt Image Text" src="../../images/2_2.png" title="Body image" /></p>
<p>而因为 <code>credential</code> 会动态的产生，所以每一个元件都会拿到不一样的 <code>credential</code>。</p>
<p>如果发现已经洩漏，也可以透过 <code>audit</code> 模组知道是哪个元件使用的 <code>credential</code> 洩露了，接著用 <code>vault</code> 撤销凭证的功能把特定的 <code>credential</code> 撤销。跟所有的元件都采用同一个 <code>credential</code> 相比，影响的范围会更小，会需要处理的工作也会更少。</p>
<h2 id="_1">范例</h2>
<p>这边用 <code>node.js</code> 展示一下 <code>vault</code> 的使用方法。</p>
<p>需求如下：<code>demo.js</code> 是一个需要存取 <code>MySQL</code> 的 <code>command line</code> 工具，我们希望定期变更 <code>demo.js</code> 使用的 <code>MySQL</code> 帐号密码来增加安全程度。在范例中我们把 <code>credential</code> 期限设定成十秒，不过一般来说线上使用时期限可能会是二週或一个月等。</p>
<p>这个范例可以在 <code>github</code> 上面找到完整的源码。</p>
<p>一般来说存取资料库大多都会到特定资料表读取与写入资料，不过在这个例子裡面我们简化 demo.js 存取 <code>MySQL</code> 拿到的资料是每秒去跟 <code>MySQL</code> 问自己目前用哪个 <code>User</code> 建立连线： <code>SELECT USER();</code>，这样范例裡面我才不用额外需要新增表格 :-)</p>
<p><code>demo.js</code> 会在几个时机跟 <code>vault/mysql</code> 沟通：</p>
<ol>
<li>初始时会跟 <code>vault</code> 动态的索取一组 <code>credential</code>，此时 <code>Vault</code> 连结 <code>MySQL</code> 帮你动态生成一组帐号密码，并且在期限后帮你删除。</li>
<li>每秒会用此 <code>credential</code> 读取 <code>MySQL</code> 内的资讯</li>
<li>到达过期时间的一半（五秒）时，跟 <code>vault</code> 拿一组新的 <code>credential</code></li>
<li>遇到无法存取资料的错误时，跟 <code>vault</code> 拿一组新的 <code>credential</code></li>
<li>结束时会把正在用的 <code>credential</code> 注销</li>
</ol>
<p><img alt="Alt Image Text" src="../../images/2_3.png" title="Body image" /></p>
<h2 id="_2">设定环境</h2>
<p>首先我们会需要 <code>MySQL</code> 跟 <code>Vault</code> 的服务，利用 <code>docker-compose</code> 可以很简单地把需要的环境建立完成。我们在 <code>docker-compose</code> 里面起了一台 <code>MySQL</code> 与一台 <code>vault</code>：</p>
<p><strong><code>docker-compose.yml</code></strong></p>
<pre><code>version: '3'
services:
  vault:
    image: vault:0.11.4
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_TOKEN}
    ports:
      - 8200:8200
  mysql:
    image: mysql:5.7
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - 3306:3306
</code></pre>
<p>透过 <code>docker-compose up</code> 就可以将 <code>mysql</code> 跟 <code>vault</code> 服务启动。</p>
<p>接下来则要设定 <code>Vault</code> 让它知道要怎么动态发出 <code>credential</code>，打开另外一个终端机分页，使用 <code>bash shell script</code> 来做初始化。这个命令使用了 <code>vault</code> 的 <code>command line</code>，<code>macOS</code> 可以利用 <code>homebrew</code>安装 <code>vault</code>。</p>
<pre><code>$ brew install vault
</code></pre>
<p><strong><code>init.sh</code></strong></p>
<pre><code>#!/bin/bash
set -x

# Load .env variables
export $(egrep -v '^#' .env | xargs)

vault secrets enable database

vault write database/config/my-database \
    plugin_name=mysql-database-plugin \
    connection_url=&quot;{{username}}:{{password}}@tcp(mysql:3306)/&quot; \
    allowed_roles=my-role username=${MYSQL_ROOT_USERNAME} password=${MYSQL_ROOT_PASSWORD}

vault write database/roles/my-role \
    db_name=my-database \
    creation_statements=&quot;CREATE USER '{{name}}'@'%' IDENTIFIED BY '{{password}}';GRANT SELECT ON *.* TO '{{name}}'@'%';&quot; \
    default_ttl=&quot;10s&quot; \
    max_ttl=&quot;20s&quot;
</code></pre>
<p>这边有几个名词先解释一下：</p>
<ul>
<li><code>secret engine:</code> 用来连接不同服务并且动态产生 <code>credential</code> 的元件，比如说 <code>database secret engine</code> 可以用来产生资料库的动态帐号密码，<code>AWS secret engine</code> 则是用来动态产生 <code>AWS IAM user</code></li>
<li><code>database</code> 组态设定：用来告诉 <code>vault</code> 要怎麽连接你的资料库，这边会需要给他足够大权限的 <code>root credential</code> 让它可以帮你根据不同的 <code>role</code> 建立不同权限范围的使用者</li>
<li><code>role</code>：因为资料库里面可能有很多不同的资料表，用多组 <code>role</code> 就可以设定不同权限范围的使用者</li>
</ul>
<p>在 <code>init.sh</code> 裡面，第 <code>7</code> 行 <code>vault secrets enable database</code> 的用途是启用 database secret engine，这个引擎支援多种资料库，可以让 <code>MySQL, PostgreSQL</code> 等资料库可以动态派送 <code>credential</code>。除此之外也有许多不同的 <code>secret engine</code> 如 <code>AWS, Azure, Google Cloud, LDAP, SSH</code> 等等，可以支援的服务非常多元。</p>
<p>第 <code>9</code> 行则是告诉 <code>vault</code> 该资料库的 <code>root credential</code> 用来建立以及删除资料库使用者，这行指令除了把 <code>root credential</code> 传给 <code>vault</code> 外还有指定我们要连接的资料库的 <code>plugin</code> 是 <code>mysql-database-plugin</code>，另外也用 <code>allowed_roles</code> 指定这个资料库设定只给 <code>my_role</code> 这个角色使用，其他 <code>role</code>则不能存取这个资料库设定。</p>
<p>第 <code>14</code> 行是建立 <code>my_role</code> 这个角色，其中 <code>creation_statements</code> 用来指定建立该使用者时的 <code>SQL</code> 语法，在这边也可以设定这个使用者对资料表的存取权限。另外这边我们设定 <code>default_ttl</code> 是十秒钟，代表透过这个 <code>role</code> 产生的 <code>credential</code> 建立后十秒钟后会过期， <code>max_ttl</code> 为 <code>20</code> 秒则是因为 <code>vault</code> 支援 <code>credential</code> 延长的功能，最多可以延长到 <code>20</code> 秒。</p>
<p>当执行 <code>init.sh</code> 后 <code>vault</code> 的设定就完成了，这时候可以利用 <code>vault</code> 来尝试发出动态的 <code>credential</code></p>
<pre><code># 读取 `.env` 裡面的环境变数
$ export $(egrep -v '^#' .env | xargs)
$ vault read database/creds/my-role
Key                Value
---                -----
lease_id           database/creds/my-role/1nZSP653ppdsrCMwDM7qDtob
lease_duration     10s
lease_renewable    true
password           A1a-4I90sOuUFcYKgeK9
username           v-token-my-role-4iDqk7sRI4m6Gocm
</code></pre>
<p>如果你手速够快的话，可以马上利用这组帐号密码登入 <code>MySQL</code>，这组帐号密码会在十秒后删除。</p>
<p>到这边就设定完成了，接下来我们来看一下 <code>demo.js</code> 的函式：</p>
<ul>
<li><code>issueCredential():</code> 利用 <code>node-vault</code> 来跟 <code>vault</code> 索取 <code>credential</code>，同时设定当时限过了一半后 <code>rotate</code> 目前正在用的 <code>credentia</code>l。</li>
<li><code>gracefulShutdown():</code> 当收到 <code>SIGTERM</code> 也就是程序用<code>kill</code>指令砍掉时，会将目前正在使用的 <code>credential</code> 撤销，这样可以让这个 <code>credential</code> 没在使用后就立即删除增加安全性。</li>
<li><code>loop(): demo script</code> 中的无限循环，会不停的跟 <code>MySQL</code> 查询目前用什麽使用者登入，如果发现 <code>SQL</code> 登入错误则重新跟 <code>vault</code> 要一组新的帐号密码。</li>
</ul>
<p><strong><code>demo.js</code></strong></p>
<pre><code>process.env.DEBUG = &quot;node-vault&quot;; // switch on debug mode

require(&quot;dotenv&quot;).config();
const mysql = require(&quot;promise-mysql&quot;);
const Vault = require(&quot;node-vault&quot;);

const { VAULT_TOKEN } = process.env;
const vault = Vault({ token: VAULT_TOKEN });

let credential;

async function issueCredential() {
  credential = await vault.read(&quot;database/creds/my-role&quot;);
  const { username, password } = credential.data;
  const leaseDuration = credential.lease_duration;
  lease_id = credential.lease_id;

  const info = [
    `Got new credential!`,
    `  username: ${username}`,
    `  password: ${password}`,
    `  lease duration: ${leaseDuration}`
  ];
  console.log(info.join(&quot;\n&quot;));

  global.setTimeout(() =&gt; {
    console.log(`Credential will expire in ${leaseDuration / 2} seconds, rotate it.`);
    issueCredential();
  }, (leaseDuration * 1000) / 2);
}

async function gracefulShutdown() {
  console.info(&quot;SIGTERM signal received.&quot;);
  await vault.revoke({ lease_id: credential.lease_id });
  process.exit(0);
}

async function loop() {
  try {
    const { username, password } = credential.data;
    const conn = await mysql.createConnection({
      host: &quot;localhost&quot;,
      user: username,
      password: password
    });
    const result = await conn.query(&quot;SELECT USER()&quot;);
    console.log(`Current user: ${result[0][&quot;USER()&quot;].split(&quot;@&quot;)[0]}`);
    conn.end();
  } catch (e) {
    console.error(e.sqlMessage);
    issueCredential();
  }
}

function main() {
  issueCredential();
  global.setInterval(loop, 1000);
  process.on(&quot;SIGTERM&quot;, gracefulShutdown);
}

if (require.main === module) {
  main();
}
</code></pre>
<p>执行 <code>demo.js</code> 时，首先会看到 <code>demo.js</code> 先跟 <code>vault</code> 要到了一组帐号密码，接下来则会每秒钟都跟资料库查询目前的使用者：</p>
<pre><code>Current user: v-token-my-role-2VWVbr1eWALVKLAB
</code></pre>
<p>过了五秒后因为距离帐号密码过期的期限只剩下一半，此时我们会再跟 <code>vault</code> 要一组新的帐号密码，接下来的资料库的使用者则变为：</p>
<pre><code>Current user: v-token-my-role-6rC0cBjcttqCUEyf
</code></pre>
<p>这两组帐号密码都是由 <code>vault</code> 动态建立，并且会在建立后十秒钟后删除。</p>
<p><img alt="Alt Image Text" src="../../images/2_4.png" title="Body image" /></p>
<p>最后当我们用 <code>kill</code> 指令停止 <code>demo.js</code> 程序时，因为我们有监听 <code>SIGTERM</code> 信号的缘故，此时除了关闭程式我们还会将最近正在使用的帐号密码撤销以增加安全性，避免此帐号密码之后还被其他人使用</p>
<h2 id="_3">踩雷区</h2>
<p>其实上面的 <code>demo.js</code> 最重要的地方就在于 <code>graceful shutdown</code> 时要把目前使用的 <code>credential</code> 给撤销掉。</p>
<p>你可能会觉得这个 <code>credential</code> 放著也还好，反正时候到了就会过期，不会有太多影响。BUT!! 假如你跟我们一样 <code>dev</code> 环境是每个 <code>commit</code> 都会 <code>deploy</code>，而且 <code>credential</code> 的过期日期设定的比较长，比如说一个月的话，每天十个 <code>commit</code>，<code>kubernetes</code> 裡面有十个 <code>pod</code>，每个 <code>pod</code>可能会用到两三个由 <code>Vault</code> 管理的动态凭证的话，你在资料库或<code>IAM User</code> 会膨胀的很快，很快地你就会发现这些为数众多的 credentials 管理上会造成困难，甚至拖累整个开发环境。</p>
<p>像最近我突然知道原来 <code>AWS IAM User</code> 的预设上限是 <code>5000</code> 人…。</p>
<p>当你有很多 <code>IAM User</code> 的时候，虽然可以透过指令一次把所有由 <code>Vault</code> 管理的 <code>IAM User</code> 撤销，但是就我们的经验来说大量 <code>revoke IAM User</code> 的时候，<code>vault</code>大多都会 <code>timeout</code> (也有可能是因为我们 dev 环境开的资源太少)，所以要执行很多次才能把所有使用者删除，其中还有可能会因为资源太少导致 <code>Vault crash</code> 的状况，在<code>production</code> 的状况 <code>vault</code> 重启会需要 <code>unseal</code>，此时就会伴随许多痛苦，甚至 <code>vault</code> 会被不停地打挂，到最后只好到 <code>backend storage</code> 跟 <code>AWS console</code> 裡面手动删除这些资料。</p>
<p>总之请大家别忘了在服务裡面加上 <code>graceful shutdown</code> 时同时也去撤销 <code>vault</code> 裡面的 <code>credential</code>，采用免得原本<code>Vault</code>是要降低痛苦却适得其反，让痛苦太多，收获太少。</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>